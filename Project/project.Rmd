---
title: "Baseball â€“ Of Ages, Salaries and Handedness"
subtitle: "Programming in Statistics - Project"
author: "Vilsmeier Johannes, Sterneder Florian, Schaub Andrea"
date: '`r Sys.Date()`'
output:
  html_document:
    code_folding: hide
    css: rstyle.css
    number_sections: yes
    theme: cosmo
    highlight: tango
    toc: yes
    toc_float: yes
---

```{r hide=T, warning=F, message=F}
library(knitr)
library(shiny)
opts_chunk$set(echo = TRUE,
               collapse = TRUE,
               comment = "",
               strip.white = TRUE,
               warning = FALSE,
               messages = FALSE,
               fig.align = "center")
source("help.R")
theme_set(theme_light())
options(warn=-1)
```  

##Introduction   

Sean Lahman's Baseball Database (Link: http://www.seanlahman.com/baseball-archive/statistics/) contains pitching, hitting, and fielding statistics for Major League Baseball (MLB) from 1871 through 2018 (for presumably every player that ever played, as well as every team that ever existed).

Section 1 is concerened with handedness. More specifically, we asked whether the distribution of right-, left- and both-handed players has changed since the MLB's inception in 1871, and whether a player's expected value differs as a function of handedness. 

In Section 2, we looked at the distribution of age and how a team's average age could be connected to its success (measured by wins). We also looked at the relationship between a player's age and the expected value to his team.  

Section 3 is all about player salaries. How did player salaries change over years? Are there any differences between leagues with respect to player salaries? How much did the highest paid players earn? How much did the highest paying teams pay? And, how do baseball players salaries compare to the average US income?  

Finally, in section 4 we use handedness, age, and salary, and built a linear model to predict a player's expected value to his team given these covariates. 

#Of Handedness and Baseball  

##Proportions of Batting And Throwing Hands Since 1871  

###Data Preparation   

Our aim was to compute and plot the proportions of left, right and - if applicable - both-handed players for each year. The `People` table from Lahman's Baseball database contains information on each player's preferred batting and throwing hand, while the `Appearances` table contains information on which players were active each year, since 1871. Thus, if a player was active in, say 1871, he should appear in the `Appearances` table and given the information on his preferred batting and throwing hand from the `People` table, we should be able to derive the number of right, left, or both-handed players that were active in a given year. 

Unfortunately, a simple join of the `People`and `Appearances` tables via the intended primary and foreign key "playerID" is not possible, since a given player can be listed multiple times in the `Appearances` table. This is usually due to players switching teams midseason. If a player switched teams, he will appear as many times in the `Appearances` table as the number of teams he played for that year. It follows that if we joined `Appearances`and `People` and computed the number/proportion of players for each handedness category and year, we would count some players more than once. 

```{r}
#Check number of observations per player and year
Appearances %>% 
  count(playerID, yearID) %>% 
  filter(n > 1)
```  
We solved this issue by creating a new table `did_appear` which indicates whether a player appeared at least once in a given year (i.e., there's only one row per year and player).

```{r}
did_appear <- 
  Appearances %>% 
  group_by(yearID) %>% 
  distinct(playerID) %>% 
  ungroup()
did_appear
```

Now, each player is counted only once per active year. 
```{r}
did_appear %>% 
  count(playerID, yearID) %>% 
  filter(n > 1)
```  
The `People` table already comes with a primary key in "playerID".

```{r}
People %>% 
  count(playerID) %>% 
  filter(n > 1)
```

We used `left_join()` to combine the `did_appear` and the `People` tables. The variable "playerID" served as primary and foreign key. In the resulting table, `players`, each row corresponds to a unique year-by-player combination. A player's preferred batting hand is encoded in the variable "bats", while his preferred throwing hand is encoded in the variable "throws". We changed these variables from type "character" to type "factor".

Unfortunately, the "throws" variable contained a single observation with the value "S" (instead of "R", or "L"). Since there was no mentioning of outcome "S" in the description of Lahman's baseball database, we concluded that this must be a typo or some other mistake. Therefore "S" was changed to "NA". 

```{r}
unique(People$throws) #possible outcomes for throws
sum(People$throws == "S", na.rm = T) #Count number of observations with "S"
People$throws[People$throws=="S"] <- NA
``` 


```{r}
players <- left_join(did_appear,People,by="playerID") %>% 
  mutate(
    bats = factor(bats, 
                  levels = c("R","L","B"),
                  labels= c("Right","Left","Both"), #3 possible outcomes
                  ordered=F),
    throws = factor(throws,
                    levels = c("R","L"),
                    labels = c("Right", "Left"), #only 2 possible outcomes
                    ordered = F)
  ) 
#check if each playerID-by-year combination is unique
players %>% 
  count(playerID, yearID) %>% 
  filter(n > 1)
```

###Batting Hand
The table `plr_bats`contains each year's total number of observations across all three handedness categories (left, right, both; "observed"), the total number of observations, irrespective of handedness category ("N"), as well as the proportion of each handedness category ("proportion"). 
```{r}
plr_bats <- players %>% 
  group_by(yearID,bats) %>% #Ensures that we get the data for each year
  count() %>%
  ungroup() %>% 
  drop_na() %>% #Drop observations for which the batting hand was not available
  group_by(yearID) %>% 
  mutate(
    "N" = sum(n), #Get total number of observations for each year (irrespective of handedness category) 
    "proportion" = round(n/sum(n),3)
  ) %>% 
  rename("observed" = n)
plr_bats
```

####Plot  
We figured that the number of observations a given year's proportional estimate is based upon may be an important piece of information. In order to include this information, we used `ggplotly()` as this allowed for the inclusion of N in `plotly`'s own "hover text". 
In more detail, we first created the `ggplot`object `batsPlot`  using `geom_lines`to connect each year's proportions, with separate lines for each handedness category. Notice that we specified a third aesthetic "label = N" in addition to the x- and y-coordinates. This third aesthetic was necessary, as the `tooltip`argument from `ggplotly()` can only display data that are specified as aesthetic arguments in the `ggplot`object. 
If you hover your cursor over any data point in the plot, a text element should pop up, displaying the year, the proportion and the total number of observations, N. To specify which aesthetics are displayed by `ggplotly`, we provided the  `tooltip` argument with a string vector of the follwoing aesthetics: "year", "proportion", "N". 


```{r}
bat_plot <- 
  #aesthetic "label" is necessary for ggplotly's tooltip argument
  ggplot(plr_bats, aes(yearID, proportion, label = N))+ 
  geom_line(aes(color=bats))+
  scale_x_continuous(name="Year", breaks = seq(1871,2018,20))+
  scale_y_continuous(breaks=seq(0,1,0.1))+
  scale_color_manual(values=c("#446A8B", "#555822", "#985C59"))+
  ylab("Proportion of Preferred Batting Hand")+
  labs(color="Batting \n Hand")+
  ggtitle("proportional distribution of batting hands")

#Convert ggplot object into plotly object
div(ggplotly(bat_plot, tooltip = c("proportion", "yearID", "N")),align="center") 
``` 
The plot might have us think that the proportion of right handed batters first increased steeply between 1871 and 1876 (up to .88, while in the same time span, the proportion of left handed batters decreased in a similar fashion) and then decreased again until settling somewhere between 0.6 and 0.7 from 1900 onwards. However, this early rise and fall in the proportion of right handed batters does not necessarily represent a genuine trend but may simply reflect the degree of uncertainty in the proportional estimates that come with relatively small sample sizes, especially in the early years. For instance, the proportional estimates for 1871 are based on a total of $N = 48$ observations and if we take a look at the actual number of observations within each handedness group we will notice that there was only **one** both handed batter in our data frame in 1871.

###Throwing Hand  

To obtain the proportions of left- and right-handed throwers for each year, we proceeded analogously to the more detailed account above. The table `plr_throws` contains each year's total number of observations for both handedness categories (left and right; "observed"), the total number of observations, irrespective of handedness category ("N"), as well as the proportion of each handedness category ("proportion"). 

```{r}
plr_throws <- players %>% 
  group_by(yearID,throws) %>% 
  count() %>%
  ungroup() %>% 
  drop_na() %>% 
  group_by(yearID) %>% 
  mutate(
    "N" = sum(n),
    "proportion" = round(n/sum(n),3)
  ) 
```

####Plot 
Again, `ggplotly()` was used to add the number of total observations a given year's proportional estimate is based upon as a text element.   

```{r}
throw_plot <- 
  ggplot(plr_throws, aes(yearID, proportion, label = N))+
  geom_line(aes(color=throws))+
  scale_x_continuous(name="Year", breaks = seq(1871,2018,20))+
  scale_y_continuous(breaks=seq(0,1,0.1))+
  scale_color_manual(values=c("#446A8B", "#555822", "#985C59"))+
  ylab("Proportion of Preferred Throwing Hand")+
  labs(color="Throwing \n Hand")+
  ggtitle("Proportional Distribution of Throwing Hands")
div(ggplotly(throw_plot,tooltip = c("proportion", "yearID", "N")), align="center")
```    
Again, the plot might have us think that the proportion of right handed throwers decreased over time (while the proportion of left handed throwers increased), yet, a more thorough inspection of the single data points reveals that the early proportional estimates are based on relatively small sample sizes, as compared to later years.

##Wins Above Replacement and Hand Preference in 2016     

Wins Above Replacement (WAR) is an often used "sabermetric" to quantify how valuable a given player is to his team's success. It is the number of a team's additional wins that are due to the player as compared to the number of expected wins if the player had been replaced by a hypothetical average player. The computation of WAR is quite complex, and, depending on whether we're dealing with a position player or a pitcher, WAR is computed differently. Luckily, baseball-reference.com provides WAR statistics for (alledgedly) every player that has ever played in the league taking into account a player's position (i.e., there are two data tables: One for position players and one for pitchers; Link: https://www.baseball-reference.com/about/war_explained.shtml).  
We downloaded Baseball Reference's "War for Position Players" (`warPos`) and "War for Pitchers" (`warPit`) tables and combined these with Lahman's baseball data bank to use WAR as the outcome variable of our linear models (see below).   

All of our linear models were restricted in that we only used data from the 2016 season. 

###Handedness and WAR for Position Players  
The aim here is to compare position players' WAR statistics as a function of batting and throwing hand. 

First, we used `filter()` to restrict our WAR and Appearances data tables to observations from the 2016 season. 
```{r}
#Select subset of position players that played in 2016
war_pos_16 <- warPos %>% 
  filter(year_ID==2016)
#Select subset of players that played in 2016
appearances_2016 <- Appearances %>% 
  filter(yearID == 2016)  
```

Next, we identified players who played for more than one team in 2016, the reason being is that these players would show up as multiple observations (i.e., multiple rows) in the `war_pos_16` data table. Also, we checked whether this conjecture of individual players showing up more than once in the table is in fact due to them playing for more than one team. 
```{r}
#Show players that played for multiple teams in 2016
war_pos_16 %>% 
  count(player_ID) %>% 
  arrange(desc(n)) %>% 
  filter(n>1)
#Check if player_ID-by-teamID is a unique key in war_pos_16
war_pos_16 %>% 
  count(player_ID, team_ID) %>% 
  filter(n>1)
```  

In order to merge `war_pos_16` and `appearances_2016` we again needed matching primary and foreign key. Unfortunately, the column "playerID" in the `appearances_2016` table does not match the column "player_ID" in the `war_pos_16` data table. There is, however, a column named "bbrefID" in `People` which corresponds to the "player_ID" column in `warPos` and `war_Pit`. Note that the `players` table created earlier already contains the "bbrefID" column. Thus, we merged `appearances_2016` with `players_2016` (i.e., subset of `players` table containing observations from 2016 only) in order to add the "bbrefID" column.  

```{r}
#Get the bbrefID column
players_2016 <- players %>% 
  filter(yearID==2016)
players_2016 %>% 
  count(bbrefID) %>% 
  filter(n > 1)
pos_2016 <- appearances_2016 %>% 
  left_join(players_2016, by="playerID")
```

Again, we checked whether the combination of "bbrefID" and "teamID" served as a key.
```{r}
#Check if bbrefID-by-teamID is a unique key in appearances_2016
pos_2016 %>% 
  count(bbrefID,teamID) %>% 
  filter(n>1)
```

We then joined `appearances_2016` and `war_pos_16` using player and team IDs as keys. 
```{r}
#Combine appearances_2016 and war_pos_16 tables
pos_2016 <- pos_2016 %>% 
  left_join(war_pos_16, by = 
              c(c("bbrefID" = "player_ID"), c("teamID"="team_ID"))) %>% 
  select(playerID, teamID, G_all, WAR, bats, throws)
pos_2016 %>% 
  count(playerID, teamID) %>% 
  filter(n>1)
```

For our linear models, we needed each player to be represented by exactly one row in the `appearances_2016` table (i.e., exactly one WAR per player). Since some players played for more than one team, and, for each team they had (slightly) different WARs we decided to weigh the player's WARs by the proportion of total games he played for each team and take the sum (i.e., a weighted mean WAR):  

$$
\text{weightedWAR}_i = \sum_{k=1}^{m}\frac{i\text{s number of games played for team }k }{i\text{s total number of games played}}\times WAR_{ik} ,
$$  
where $i$ refers to the $i$th player, and $k$ to the $k$th team he played for in 2016. Note that if a player's WAR for a given team was coded as `NA`, the player's stint with that team was simply ignored in the computation. This step is reflected in the `drop_na()` command in the function `wghtWAR()` (see help.R file). 


In order to apply the `wghtWAR()` function to each player, we first nested WAR within players. We then used `lapply()` to compute the weighedWAR statistic for each player. 
```{r warning=F}
#Nest number of WAR-osbervations by players
pos_2016 <- nest(pos_2016, c(G_all,teamID), key = "WAR")
#Compute weighted WAR for each player
pos_2016 <- pos_2016 %>% 
  mutate(
  "weightedWAR" = lapply(pos_2016$data, function(x) wghtWAR(x)) %>% unlist
)   
```

We then plotted "weightedWAR" as a function of batting hand.
```{r}
#raw data for batting hand
pos_2016 %>% 
  drop_na() %>% 
  ggplot()+
  geom_jitter(aes(bats,weightedWAR),alpha=.5,
              position=position_jitter(width=.2))+
  xlab("Batting Hand")+
  ylab("Weighted Average WAR")+
  ggtitle("Position Players: WAR by Batting Hand")
```
The scatter plot indicates that for position players, on average, right, left and both handed batters do not differ with respect to WAR.  

Let's build a linear model to obtain a closer look. We chose right-handed batters as our reference category. The linear model looked as follows:  
$$
\widehat{y}_i = \widehat{\beta}_0+\widehat{\beta}_1 Left_i+\widehat{\beta}_2 Both_i
$$

```{r}
model_bats_pos <- lm(weightedWAR~bats, data = pos_2016)
```

```{r results = "asis"}
stargazer(model_bats_pos, type = "html", align = T)
```


The scatter plot for throwing hand:
```{r}
#raw data for throwing hand
pos_2016 %>% 
  drop_na() %>% 
  ggplot()+
  geom_jitter(aes(throws,weightedWAR),alpha=.5,
              position=position_jitter(width=.2)) +
  xlab("Throwing Hand")+
  ylab("Weighted Average WAR")+
  ggtitle("Position Players: WAR by Throwing Hand")
```
The average WAR of right versus left handed throwers does not seem to differ for position players. 

The linear model:
$$
\widehat{y}_i = \widehat{\beta}_0+\widehat{\beta}_1 Left_i
$$  
```{r}
model_throws_pos <- lm(weightedWAR~throws, data = pos_2016)
```

```{r results = "asis"}
stargazer(model_throws_pos, align = T, type = "html")
```


###Handedness and WAR for Pitchers
Analogously to the previous section on handedness and WAR for position players, we first selected the subset of all players that were pitchers in 2016 from the `warPit` table as well as the subset of all players that appeared in 2016 from the `Appearances` table. We then added the column bbrefID from the `players` table to match the observations in `appearances_2016` with the observations in `war_pit_16`(see code). 
```{r}
#Select subset of pitchers that played in 2016
war_pit_16 <- warPit %>% 
  filter(year_ID==2016)
#Check if player_ID, team_ID ist key
war_pit_16 %>% 
  count(player_ID, team_ID) %>% 
  filter(n>1)
#Add bbrefID column to pit2016
pit_2016 <- appearances_2016 %>% 
  left_join(players_2016, by="playerID")
#Combine appearances_2016 and warPit2016 tables
pit_2016 <- pit_2016 %>% 
  left_join(war_pit_16, by = 
              c(c("bbrefID" = "player_ID"), c("teamID"="team_ID"))) %>% 
  select(playerID, teamID, G_all, WAR, bats, throws)
```


Again, we nested "teams", "games played", and "WAR" within players and applied `wghtWAR()` to obtain a weighted average WAR for each player. 
```{r}
#Nest number of WAR-osbervations by players
pit_2016 <- nest(pit_2016, -playerID, -bats, -throws)
#Compute weighted WAR for each player
pit_2016 <- pit_2016 %>% 
  mutate(
  "weightedWAR" = lapply(pit_2016$data, function(x) wghtWAR(x)) %>% unlist
)   
```

The scatterplot plot for WAR by batting hand:
```{r}
#raw data for batting hand
pit_2016 %>%   
  drop_na() %>% 
  ggplot()+
  geom_jitter(aes(bats,weightedWAR),alpha=.5,
              position=position_jitter(width=.2))+
  xlab("Batting Hand")+
  ylab("Weighted Average WAR")+
  ggtitle("Pitchers: WAR by Batting Hand")
``` 
Again, the plots do not indicate any mean difference between right, left and both handed players with respect to WAR. 

The linear model for batting hand:
```{r}
model_bats_pit <- lm(weightedWAR~bats, data = pit_2016)
```

```{r results = "asis"}
stargazer(model_bats_pit, align = T, type = "html")
``` 

The scatter plot for WAR by throwing hand:
```{r}
#raw data for throwing hand
pit_2016 %>%   
  drop_na() %>% 
  ggplot()+
  geom_jitter(aes(throws,weightedWAR),alpha=.5,
              position=position_jitter(width=.2)) +
  xlab("Throwing Hand")+
  ylab("Weighted Average WAR")+
  ggtitle("Pitchers: WAR by Throwing Hand")
```
No mean group differences seem to be present.

The linear model for throwing hand: 
```{r}
model_throws_pit <- lm(weightedWAR~throws, data = pit_2016)
```

```{r results = "asis"}
stargazer(model_throws_pit, align = T, type = "html")
``` 

# Of Age and Baseball
This chapter analyzes the age of baseball players, focusing on the season of 2016. First the average age is computed, then differences between the teams and their average players age are analyzed. At the end of this chapter, we will build a model which tries to answer the questions "How old is a good baseball player?" or "Do they get better with age?".

## Age of the average active baseball player in 2016

```{r}
age_calc <- function(from,to=now()) difftime(to, from)/dyears(1)
age_current <- 2016
age_const <- function(year=2016) paste0(year,"0403")
age_c_players <- 
  left_join(Appearances %>% filter(yearID == age_current), People, "playerID") %>%
  mutate(birthDate = as_date(ymd(paste(birthYear, birthMonth, birthDay, sep = "-")))) %>%
  mutate(age = age_calc(birthDate, ymd(age_const(age_current)))) %>%
  select(playerID, teamID, birthDate, age, nameFirst, nameLast, G_all, GS) 
```

We define active as in "played in season `r age_current`". Also we calculate the age with the start of the season (April 3rd).

We find that the average active professional baseball player , in the season of `r age_current`, was born `r mean(age_c_players$birthDate)` and was therefore `r floor(age_calc(mean(age_c_players$birthDate),ymd(age_const(age_current))))` years old. 

Let's visualize that.

```{r}
age_plot <- age_c_players %>% 
    ggplot(aes(x = age)) +
    geom_line(stat="density") + 
    geom_vline(aes(xintercept = mean(age)), alpha = 0.5, color = "#3068A1") +
    labs(x = "Age", y = "Density", title = "Age Density")

div(ggplotly(age_plot), align = "center")
```

Funfact: As we might be able to tell from the graph, the oldest player in the season of `r age_current` was `r age_calc(min(age_c_players$birthDate),ymd(age_const(age_current)))`.

Now we know more about the average active player in `r age_current`. Let's go further.

## Differences in the age distribution per team

```{r}
names(color$team_main) <- sort(unique(age_c_players$teamID))
age_c_team <- age_c_players %>% 
   group_by(teamID) %>%
   summarise(meanAge = mean(age), medianAge = median(age)) %>%
   left_join(Teams %>% filter(yearID == age_current) %>% select(teamID,name,W,L,G), by = "teamID")
 
age_c_team %>% 
    ggplot(aes(reorder(teamID,meanAge), meanAge, color = teamID)) +
    geom_point(size = 2) + 
    scale_color_manual(values = color$team_main) +
    guides(color = FALSE) + labs(x = "Team", y = "Average Age", title = "Average Age by Team") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```
So now we know that the the team with the - on average - youngest players are the `r (age_c_team %>% filter(meanAge == min(meanAge)))$name` while the `r (age_c_team %>% filter(meanAge == max(meanAge)))$name` deploys - again, on average - the oldest players. The difference between these 'extremes' is `r signif(max(age_c_team$meanAge) - min(age_c_team$meanAge),3)` and is less than one might would have expected. Having a roster of 40 players per team possibly has an effect here.

We still want to know more, let's look at the related boxplot.

```{r}
age_c_players %>% 
    left_join(age_c_team, by = "teamID") %>%
    ggplot(aes(reorder(teamID,meanAge),age,color = teamID)) +
    geom_boxplot(notch = TRUE) +
    scale_color_manual(values = color$team_main) +
    guides(color = FALSE) + labs(x = "Team", y = "Average Age", title = "Average Age by Team") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```
As we see, the IQR and Median isn't _that_ different between the teams. Maybe we can work out larger differences in the next question.

## Weighted average team age

The idea is to weight the playing time of each player and therefore see if teams rather put their faith in younger players or value experience. The formula we use to weigh each time is $$ \text{age}_p \frac{\text{games played}_p}{\frac{1}{n}\sum^n_{i=1}\text{games played}_i} $$

```{r}
age_c_team <- 
   left_join(
             age_c_players,
             (Teams %>% filter(yearID == age_current) %>% select(teamID,G, W, L)),
             "teamID"
            ) %>%
   group_by(teamID) %>% 
   add_count() %>%
   mutate(G_avg = mean(G_all),GS_avg = mean(GS)) %>%
   mutate(gProp = age*(G_all/G_avg), gsProp = age*(GS/GS_avg)) %>%
   summarise(weightByG = mean(gProp), weightByGS = mean(gsProp)) %>%
   left_join(age_c_team, "teamID")
age_c_team %>% 
    ggplot(aes(reorder(teamID, meanAge), weightByG, color = teamID)) +
    geom_point(aes(reorder(teamID, meanAge), meanAge, color = teamID), size = 0.8) +
    geom_point(size = 2) + 
    scale_color_manual(values = color$team_main) +
    geom_segment(aes(xend = teamID, yend = meanAge)) +
    guides(color = FALSE) + 
    labs(y = "Age Weighted By Games Played", x = "Team", title = "Difference in Average Age after Weighting per Team") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) 
```

As we can can see, there are some differences if we weight the playing time, but most noticeable is that the shift is clearly toward more experienced players. To be exact, according to this new metric the average team is now `r signif(age_c_team %>% summarise(mean(weightByG-meanAge)),4)` years older which adds up to `r signif(age_c_team %>% summarise(sum(weightByG-meanAge)),4)` years in total for the whole league.

## Games Won and Average Team Age 

### Season 2016

With the information we got so far we build a linear model to see if there is a connection between the percentage of games won by a team and their weighted average age. The model looks like this:

$$ \hat{\text{Wprop}}_i = \hat{\beta_0} + \hat{\beta_1} \text{Age}_i $$

```{r}
age_c_team <- age_c_team %>% mutate(Wprop = W/G)
age_team_perf_mod <- lm(data=age_c_team, formula= Wprop ~ weightByG)
age_c_team <- age_c_team %>% add_predictions(age_team_perf_mod) %>% add_residuals(age_team_perf_mod)

age_c_team %>% 
  ggplot(aes(weightByG)) + 
  geom_point(aes(y=Wprop)) +
  geom_line(aes(y=pred),color="#3068A1") +
  labs(x = "Age Weighted By Games Played", y = "% Games won", title = "Linear Model Visualization")

age_c_team %>% 
  ggplot(aes(weightByG, resid)) +
  geom_point() +
  geom_ref_line(h = 0, colour = "gray85") +
  labs(y = "Residuals", x = "Age Weighted By Games Played", title = "Visualization of Residuals")
```

```{r results="asis"}
stargazer(age_team_perf_mod, align=T, type='html', style="all2")
```

If we believe in this model than we could argue, since there is a positive slope, that it would be advantageous for a team to field (exclusivly?) older players. But although this model looks promising, it might suffer from a rather small sample size ($N=30$). In the next step we are going to expand our sample by looking at the data from the season 1985 to 2016.

### Season 1985 - 2016
```{r}
age_from = 1985
age_f_players <- 
  left_join(Appearances %>% filter(yearID %in% seq(from = age_from, to = age_current)), People, "playerID") %>%
  mutate(birthDate = as_date(ymd(paste(birthYear, birthMonth, birthDay, sep = "-")))) %>%
  mutate(age = age_calc(birthDate, ymd(age_const(yearID)))) %>%
  select(yearID, playerID, teamID, birthDate, age, nameFirst, nameLast, G_all, GS) 

age_f_team <- age_f_players %>% 
   group_by(yearID, teamID) %>%
   summarise(meanAge = mean(age), medianAge = median(age)) %>%
   left_join(Teams %>% filter(yearID %in% seq(from= age_from, to = age_current)) %>% select(yearID, teamID,name,W,L,G), by = c("teamID","yearID"))

age_f_team <- 
   left_join(
             age_f_players,
             (Teams %>% filter(yearID %in% seq(from = age_from, to = age_current)) %>% select(teamID,G, W, L)),
             "teamID"
            ) %>%
   group_by(yearID, teamID) %>% 
   add_count() %>%
   mutate(G_avg = mean(G_all),GS_avg = mean(GS)) %>%
   mutate(gProp = age*(G_all/G_avg), gsProp = age*(GS/GS_avg)) %>%
   summarise(weightByG = mean(gProp), weightByGS = mean(gsProp)) %>%
   left_join(age_f_team, c("teamID","yearID"))
```

## Age and Wins Above Replacement

```{r}
age_war_pos <- left_join(age_c_players, pos_2016 %>%
 select(-bats,-throws,-data)) %>%
 group_by(playerID,birthDate,age,weightedWAR) %>% 
 summarise(G_all = sum(G_all), GS = sum(GS)) %>%
 ungroup()

age_war_pit <- left_join(age_c_players, pit_2016 %>%
 select(-bats,-throws,-data)) %>%
 group_by(playerID,birthDate,age,weightedWAR) %>% 
 summarise(G_all = sum(G_all), GS = sum(GS)) %>%
 ungroup()
```

### Missing values

Pos
`r dim(age_war_pos %>% filter(is.na(weightedWAR)))[1]` out of `r dim(age_war_pos)[1]`.

Pit
`r dim(age_war_pit %>% filter(is.na(weightedWAR)))[1]` out of `r dim(age_war_pit)[1]`.

```{r}
age_war_pos <- age_war_pos %>% drop_na(weightedWAR)
```

Implicitly missing values?

### Model Position



```{r}
age_war_pos_mod <- age_war_pos %>% lm(formula = weightedWAR ~ age)
age_war_pos <- age_war_pos %>% add_predictions(age_war_pos_mod) %>% add_residuals(age_war_pos_mod)
```


```{r}
age_war_pos_mod <- age_war_pos %>% lm(formula = weightedWAR ~ age)
age_war_pos <- age_war_pos %>% add_predictions(age_war_pos_mod) %>% add_residuals(age_war_pos_mod)


age_war_pos %>% 
  ggplot(aes(age)) + 
  geom_point(aes(y=weightedWAR)) +
  geom_line(aes(y=pred),color="#3068A1")
```

```{r results="asis"}
stargazer(age_war_pos_mod, align=T, type='html')
```

### Model Pitcher

```{r}
age_war_pit_mod <- age_war_pit %>% lm(formula = weightedWAR ~ age) 
age_war_pit <- age_war_pit %>% add_predictions(age_war_pit_mod) %>% add_residuals(age_war_pit_mod)

age_war_pit %>% 
  ggplot(aes(age)) + 
  geom_point(aes(y=weightedWAR)) +
  geom_line(aes(y=pred),color="#3068A1")
```

```{r results="asis"}
stargazer(age_war_pit_mod, align=T, type='html')
```

## Age and Wins Above Replacement - Combined

### Prep

```{r}
combo_2016 <- 
  left_join(pit_2016, pos_2016, c("playerID","bats","throws")) %>%
  mutate(weightedWAR.y = if_else(is.na(weightedWAR.y),0,weightedWAR.y)) %>%
  mutate(weightedWAR = weightedWAR.x + weightedWAR.y, data = data.x) %>%
  select(-data.x, -data.y, -weightedWAR.x, -weightedWAR.y)

age_war_combo <- left_join(age_c_players, combo_2016 %>%
  select(-bats,-throws,-data)) %>%
  group_by(playerID,birthDate,age,weightedWAR) %>% 
  summarise(G_all = sum(G_all), GS = sum(GS)) %>%
  ungroup()
```

### Model

```{r}
age_war_combo_mod <- age_war_combo %>% lm(formula = weightedWAR ~ age)
age_war_combo <- age_war_combo %>% add_predictions(age_war_combo_mod) %>% add_residuals(age_war_combo_mod)

age_war_combo %>% 
  ggplot(aes(age)) + 
  geom_point(aes(y=weightedWAR)) +
  geom_line(aes(y=pred),color="#3068A1")
```

```{r results="asis"}
stargazer(age_war_combo_mod, align=T, type='html')
```

# Of Salaries and Baseball
After looking at the average age of baseball players, we take a look on what they earn. Is it more/less depending on the league? How is the development compared to the average US-salary? After answering these questions, the mostpaid players in the 2000s and mostpaying teams in 2016 are also listed. The main questions, if a good baseball player also gets paid high, and if a team that spends much on their players, wins more, are asked at the end. 

##Adjusting the statistics
Before starting the analysis, we have to prepare our data. For the salaries, we have one table containing the average US-salaries from 1989-2017, and another table containing all baseball-players' salaries from 1989-2016. 

###US-Salaries
The statistics for the average wage in the US came from the OECD (https://data.oecd.org/earnwage/average-wages.htm#indicator-chart). Unfortunately, we didn't find more accurate data for the wages than the average. Be careful with interpreting the numbers, as with wages, the mean and the median differ a lot. 
Within the dataset some columns were dropped, and the average development in percent was calculated. 
```{r salaries_us_adjust}
#renaming the columns
colnames(Salaries_US) = c("country", "indicator", "subject", "currency", "frequency", "yearID", "av_wage_US", "Flag_codes")
Salaries_US <- Salaries_US %>%
  #dropping columns
  subset(select = -c(country, indicator, subject, frequency, Flag_codes)) %>%
  #calculating average development
  mutate(av_wage_US = av_wage_US/1000000,
         av_wage_perc = ((av_wage_US/lag(av_wage_US) - 1) * 100),
         av_wage_100perc = ((av_wage_US-min(av_wage_US))/max(av_wage_US)))
(Salaries_US)
```
  
###Baseball-Salaries
With the baseball salaries, some statistical values, like mean, max, min and median were calculated. Also the average development of the mean salary was computed to compare it to the US salaries. 
```{r salaries_adjust}
Salaries <- Salaries %>%
  mutate(salary = salary/1000000)
(Salaries)
sal_bb_stats <- Salaries %>%
  group_by(yearID) %>%
  summarise(n_players = n(), 
            n_teams = n_distinct(teamID),
            n_dist_players = n_distinct(playerID),
            salary_mean = mean(salary),
            salary_max = max(salary),
            salary_min = min(salary),
            salary_median = quantile(salary, probs = 0.5))
sal_bb_stats
#
sal_bb_stats_90 <- sal_bb_stats %>%
  filter(yearID >= 1990) %>%
  mutate(salary_mean_perc = ((salary_mean/lag(salary_mean) - 1) * 100),
         salary_mean_100perc = ((salary_mean-min(salary_mean))/max(salary_mean))) 
```
  
##Overview
The boxplot shows the median salary, and the first and third quantile. There are a lot of outliers, the mean salary is also shown. In 2000 there was a leap in the median salary, and in and after 2009, the highest salaries so far were payed. We're going to take a look at that afterwards. 
```{r salaries_statistics, cache = T}
summary(Salaries)
#boxplot with the player salaries
sal_boxplot <- ggplot() + 
  geom_boxplot(data = Salaries, aes(x = yearID, y = salary, group = cut_width(yearID, 1)), alpha = 0.5) + 
  geom_line(data = sal_bb_stats, aes(x = yearID, y = salary_mean), color = "#3068A1") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = Salaries$yearID) +
  labs(x = "Year", y = "Salary in million US$", 
       title = "Baseball-players' Salaries") 
(sal_boxplot)
```
  
###About missing data

To find out about missing data, the number of players and teams was analyzed. Explicitly missing data is not stored in the tables we have, but there seems to be implicitly missing data. The number of players spikes a lot through the years, and there are also players, who got paid by more than one team a year, which can be seen in the difference between the number of players and the distinct number of players per year. As this analysis is about average salaries, we will keep all the data, because wheter somebody was paid twice or once does not matter. They played more, so they earned more. 
```{r salaries_missing_data, cache = T}
#graph with number of players per year
sal_bb_nbplayers <- ggplot(data = sal_bb_stats) + 
  geom_line(mapping = aes(x = yearID, y = n_dist_players), color = "#384F5d") +
  geom_line(mapping = aes(x = yearID, y = n_players), color = "#3068A1") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = Salaries$yearID) +
  labs(x = "Year", y = "Number of players", 
       title = "Number of players with salary information each year")
div(ggplotly(sal_bb_nbplayers), align = "center")
#graph with number of teams per year
sal_bb_nbteams <- ggplot(data = sal_bb_stats, mapping = aes(x = yearID, y = n_teams)) + 
  geom_line(color = "#3068A1") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = Salaries$yearID) +
  labs(x = "Year", y = "Number of teams", 
       title = "Number of Teams with salary information each year")
div(ggplotly(sal_bb_nbteams), align = "center")
```

##Salaries within the leagues
Let's focus on the differences within the leagues. We have 2 leagues within the salaries data, the National League (NL) and the American League (AL). In the scatterplot we see, that the differences between the average salary and maximum salary grow with time, so this is not caused by any league paying highly more, although there are differences: The maximum gaining players of the AL earn more money than the ones from the NL (except for 2015 and 2016). 
```{r salaries_lg}
#computing the stats for leagues 
sal_bb_stats_lg <- Salaries %>%
  group_by(yearID, lgID) %>%
  summarise(n_players_lg = n(), 
         salary_lg_mean = mean(salary),
         salary_lg_max = max(salary),
         salary_lg_min = min(salary),
         salary_lg_median = quantile(salary, probs = 0.5)) %>%
  mutate(salary_lg_100perc = (salary_lg_mean-min(salary_lg_mean)/max(salary_lg_mean)))
(sal_bb_stats_lg)
#graph with the salaries, grouped by league
sal_lg <- 
  ggplot(data = Salaries, mapping = aes(x = yearID, y = salary)) + 
  geom_point(mapping = aes(color = lgID), alpha = "0.3", position = "jitter") + 
  geom_smooth(method='lm', se=F, color = "#93adc8") + 
  scale_color_manual(values=c("#446a8b", "#985c59")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = sal_bb_stats_lg$yearID) +
  labs(x = "Year", y = "Salary in million US$",
       title = "Baseball-players' salaries, grouped by league")
(sal_lg)
```
  
Over the average salaries (despite looking at the mean or the median), the AL also pays more. Looking at range, which tells us about the gap between the minimum and maximum salary of the players, we can see, that the gap was increasing over time. Also the range was higher in the AL until 2014, where the AL range dropped and the NL range continued to rise.  
```{r salaries_lg_mean}
#graph with median and mean salary per year and league
sal_bb_stats_lg_all <- sal_bb_stats_lg %>%
  gather(key="statistics_type", value = "salary", salary_lg_mean, salary_lg_median) %>%
  ggplot(mapping = aes(shape = lgID), size = 10) +
  geom_line(mapping = aes(x = yearID, y = salary, color = lgID)) +
  scale_color_manual(values=c("#446a8b", "#985c59")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = sal_bb_stats_lg$yearID) +
  labs(x = "Year", y ="Salary (median, mean) in million US$",
       title = "Median and mean salary per year and league")
stat_type_names <- c(salary_lg_median = "Median Salary", salary_lg_mean = "Mean Salary")
(sal_bb_stats_lg_all)+facet_wrap(vars(statistics_type), nrow=2, labeller = as_labeller(stat_type_names))
#Range of bb salaries in leagues
sal_bb_stats_lg_range <- 
  ggplot(data = sal_bb_stats_lg, mapping = aes(color = lgID)) +
  geom_line(mapping = aes(x = yearID, y = salary_lg_max-salary_lg_min)) +
  scale_color_manual(values=c("#446a8b", "#985c59")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = sal_bb_stats_lg$yearID, labels = scales::comma) +
  labs(x = "Year", y = "Range of salaries in mllion US$", 
       title = "Range of baseball players' salaries by league")
div(ggplotly(sal_bb_stats_lg_range), align = "center")
```

##Compared to US-salaries
The average baseball salaries increased a lot with time. Let's compare it to the average US salaries and see if they rose alike. 
We can see, that the average salary of baseball players is a lot higher. To see the differences more, we compare the percentage rise over time. Starting at 1990 (because the US Salary data is not available for the years before), the average US wages increased about 25% until 2016, whereas the baseball players' salaries increased more than 85%. This is a huge difference. So, baseball probably became more popular or at least, people want to spend more on the games and the teams, the teams might have more money because of bigger sponsoring and so on. 

```{r salaries_comparison_us} {.tabset}
sal_bb_us <- left_join(sal_bb_stats_90, Salaries_US, by = "yearID")
(sal_bb_us) 
#graph with average salaries per year for bb
sal_bb_us_av <- 
  ggplot(data = sal_bb_us) + 
  geom_point(mapping = aes(x = yearID, y = salary_mean), color = "#446A8B") + 
  geom_smooth(mapping = aes(x = yearID, y = salary_mean), color = "#748CA1", method='lm', se=F) + 
  geom_point(mapping = aes(x = yearID, y = av_wage_US), color = "#555822") + 
  geom_smooth(mapping = aes(x = yearID, y = av_wage_US), color = "#969656", method='lm', se=F) + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = sal_bb_us$yearID) +
  labs(x = "Year", y = "Average salary in million US$", 
       title = "Average salary of baseballers and US citizens")
div(ggplotly(sal_bb_us_av), align = "center")
sal_bb_us_dev <- ggplot(data = sal_bb_us) + 
  geom_point(mapping = aes(x = yearID, y = salary_mean_100perc), color = "#446A8B") + 
  geom_smooth(mapping = aes(x = yearID, y = salary_mean_100perc), color = "#748CA1", method='lm', se=F) + 
  geom_point(mapping = aes(x = yearID, y = av_wage_100perc), color = "#555822") + 
  geom_smooth(mapping = aes(x = yearID, y = av_wage_100perc), color = "#969656", method='lm', se=F) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = sal_bb_us$yearID) +
  labs(x = "Year", y = "% rise in salary of baseballers and US citizens", 
       title = "Salarydevelopment of baseballers and US citizens")
div(ggplotly(sal_bb_us_dev), align = "center")
```
  
##Mostpaid players

The rise in the salaries was mainly conducted by some high earninig players - why do they get paid so much more than others? Are they better? To answer these questions the players with the largest salaries each year (after 2000, where the gap was getting a lot bigger) were chosen for further analysis. 
```{r salaries_mostp_pl_teams}
#calculating the players with the max salary since 1999
salary_max <- Salaries %>%
  filter(yearID > 1999) %>%
  group_by(yearID) %>%
  mutate(max_salary = max(salary)) %>%
  subset(salary == max_salary) %>%
  ungroup()
(salary_max)
#checking how often somebody was mostpaid
mostpaid_players <- salary_max %>%
  group_by(playerID) %>%
  summarise(mostpaid_player = n()) %>%
  ungroup()
(mostpaid_players)
#getting the salary development of the max paid players (2000-2016)
sal_mostp_pl <- Salaries %>%
  filter(playerID %in% (salary_max$playerID))
(sal_mostp_pl)
```

###Over time
The two most earning players in 2015 and 2016 (Greinza01 and Kershcl01) were quite new in the game, whereas rodrial01 was the mostpaid player for a long time. Brownke01, playing until 2005, had a long career before he was most paid. After getting most money, he didnt develop anymore, his salary stayed the same. Giambja01 and Ramirma01 had a similar development in salary, with Ramirma01 getting less between 2007 and 2009 and then earning more again. 
```{r salaries_mostpaid_players}
sal_mostp_pl_all <- 
  ggplot(data = sal_mostp_pl, mapping = aes(x = yearID, y = salary)) + 
  geom_line(mapping = aes(color = playerID)) + 
  geom_point(mapping = aes(color = playerID))+
  scale_color_manual(values = c("#A7C4E3", "#74a9cf", "#4B88C8", "#0570b0", "#446a8b", "#323135")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = sal_bb_stats_lg$yearID) +
  labs(x = "Year", y = "Salary per player in million US$", 
       title = "Salaries of the mostpaid baseball-players over time")
(sal_mostp_pl_all)
```
  
###In 2016

Let's also take a look at the most paid players in 2016 and their development. We filter the salaries table for data on 2016 and then get the playerIDs. We take all those players and arrange them descending to get the ones with the most salaries on top. Then we take the top 5 rows, using [1:5,]. For the development of the players, we take the Salaries table and look for the top5-earning players. 
  
Greinza01 and Kershcl01, most earning in 2015 and 2016, had a shorter career comparing to the others. Also Greinza01 had the highest salary to start with. The other players have been playing in Major League Baseball for at least 10 years before getting paid more than 25 million US\$.  

```{r sal16_most_players}
#getting players for only 2016, players with more than one salary will be excluded
salaries16_players <- Salaries %>%
  filter(yearID == 2016) %>%
  group_by(playerID) %>%
  summarise(n_plID = n()) %>%
  filter(n_plID == 1)%>%
  print()
#getting the salaries for all these players
salaries16 <- Salaries %>%
  filter(yearID == 2016) %>%
  filter(playerID %in% salaries16_players$playerID)%>%
  print()
#getting the names of the top5 earning players in 2016
sal16_pl_top5 <- Salaries %>%
  filter(playerID %in% salaries16$playerID) %>%
  arrange(desc(yearID), desc(salary))%>%
  print()
sal16_pl_top5 <- sal16_pl_top5[1:5,]
#getting the development of the top5 earning players
sal_mostp_pl_in16 <- Salaries %>%
  filter(playerID %in% sal16_pl_top5$playerID) %>%
  arrange(desc(yearID), desc(salary))%>%
  print()
sal_mostp_pl_in16
sal_mostp_pl_in16_plot <- ggplot(data = sal_mostp_pl_in16, mapping = aes(x = yearID, y = salary)) + 
  geom_line(mapping = aes(color = playerID)) + 
  scale_color_manual(values = c("#A7C4E3", "#74a9cf", "#4B88C8", "#446a8b", "#323135")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = sal_bb_stats_lg$yearID) +
  labs(x = "Year", y = "Salary per player in million US$", 
       title = "Salaries of the mostpaid baseball-players over time")
(sal_mostp_pl_in16_plot)
```
  
###High paid players - are they better? 

To find out about the relationship of salary and being a good player we'll construct a linear model. We will compare the players' salaries to the Wins above replacement for position players and for pitching. To shorten the code, we make a function to calculate our linear model. 
```{r lm_function}
lm_own <- function(df, y1, x1, txt_y, txt_x, txt_title, plot = T) {
  #formula has to be done seperately
  #otherwise the lm would take either the names "y1" and "x1" without finding columns
  #or find the columns df[[y1]] and df[[x1]] but using y1 and x1 also as names 
  f <- as.formula(paste(y1, x1, sep = "~"))
  lm_df <- lm(formula = f, data = df)
  
  if(plot == T) {
    #adding the predictions and residuals
    df <- df %>%
    add_predictions(lm_df) %>%
    add_residuals(lm_df)
  
    #plotting the data
    lm_df_plot <- df %>%
    #refering to the columns with df[[x|y1]]
    ggplot(aes(df[[x1]])) +
    geom_point(aes(y=df[[y1]])) +
    #adding the prediction line
    geom_line(aes(y=pred), color = "#3068A1") +
    #naming the axes and title
    labs(x = txt_x, y = txt_y, title = txt_title)}
  else{return(lm_df)}
}
```

For the model, we also need to prep our data. We make two tables, one containing WARpos and the other WARpit. We use an inner join to keep the rows with data on both salary and war, and use an anti-join to see what data we've lost. 

  
###In 2016

###High paid players - are they better? 

To find out about the relationship of salary and being a good player we'll construct a linear model. We will compare the players' salaries to the Wins above replacement for position players and for pitching. To shorten the code, we make a function to calculate our linear model. 

For the model, we also need to prep our data. We make two tables, one containing WARpos and the other WARpit. We use an inner join to keep the rows with data on both salary and war, and use an anti-join to see what data we've lost. 
```{r salaries16_prep}
#using an inner join to only hold the rows with WAR and salary
salaries16_pl_warPos <- inner_join(salaries16, pos_2016, "playerID")
(anti_join(salaries16, pos_2016, "playerID"))
(anti_join(pos_2016, salaries16, "playerID"))
#using an inner join to only hold the rows with WAR and salary
salaries16_pl_warPit <- inner_join(salaries16, pit_2016, "playerID")
#using anti_joins in both directions to see the data loss
(anti_join(salaries16, pit_2016, "playerID") %>% print())
(anti_join(pit_2016, salaries16, "playerID") %>% print())
```
  
####Salary and Wins above replacement
Then we start the modeling. First we look at how WAR affects the salary. 
```{r lm_war_salary}
lm_warpos_salary <- lm_own(salaries16_pl_warPos, "salary", "weightedWAR", 
                           "Salary in million US$", "Wins above replacement (pos. players)", 
                           "Linear model on the player's salary and \n
                           Wins above Replacement for position players") 
(lm_warpos_salary)
lm_warpit_salary <- lm_own(salaries16_pl_warPit, "salary", "weightedWAR", 
                           "Salary in million US$", "Wins above replacement (pitching)", 
                           "Linear model on the player's salary and \n
                           Wins above Replacement for pitching")
(lm_warpit_salary)
```
  
####Wins above replacement and salary  
Then we look the other direction: What influence has the salary on WAR?
```{r lm_salary_war}
lm_salary_warpos <- lm_own(salaries16_pl_warPos, "weightedWAR", "salary",
                           "Wins above replacement (pos. players)", "Salary in million US$", 
                           "Linear model on Wins above Replacement for position players \n
                           and the player's salary")
(lm_salary_warpos)
lm_salary_warpit <- lm_own(salaries16_pl_warPit, "weightedWAR", "salary",
                           "Wins above replacement (pitching)", "Salary in million US$", 
                           "Linear model on Wins above Replacement for pitching \n
                           and the player's salary")
(lm_salary_warpit)
```

```{r comparing_salary_war}
lm(data = salaries16_pl_warPit, formula = weightedWAR ~ salary)
stargazer(lm(data = salaries16_pl_warPit, formula = weightedWAR ~ salary))
lm(data = salaries16_pl_warPit, formula = weightedWAR ~ salary)
stargazer(lm(data = salaries16_pl_warPit, formula = weightedWAR ~ salary,
          type = "HTML"))
```


##Mostpaying teams

###2016's Top 5 over time
To find out more about the mostpaying teams, we take the Top 5 from 2016 and look at their development.
BOS, DET, LAN, NYA and TEX spent the most money on their players in 2016. Looking at their development, the NYA paid a lot more since 2002. LAN had a big rise in 2013, and TEX had less money between 2004 and 2010. As we know, that the number of players with salary information is not constant, changes in the salary sum can be due to the changing number of players. We also looked at the mean, and the development is similar - therefore we chose to stick to the graph with 
  
  
```{r}
#getting the top5 most spending teams
mostpaying_teams <- Salaries %>%
  filter(yearID == 2016) %>%
  group_by(yearID, teamID) %>%
  summarise(salary_sum = sum(salary)) %>%
  arrange(desc(salary_sum))
mostpaying_teams <- mostpaying_teams[1:5,]
#getting all data on those teams, calculating the sum and average salary
mostpaying_teams_dev <- Salaries %>%
  filter(teamID %in% mostpaying_teams$teamID) %>%
  group_by(yearID, teamID) %>%
  summarise(salary_sum = sum(salary), 
            salary_mean = mean(salary))
#plotting the sum of salaries
sal_mostp_teams_sum <- 
  ggplot(data = mostpaying_teams_dev) + 
  geom_line(mapping = aes(x = yearID, y = salary_sum, color = teamID)) + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_color_manual(values = c("#A7C4E3", "#74a9cf", "#4B88C8", "#446a8b", "#323135")) +
  scale_x_continuous(breaks = sal_bb_stats_lg$yearID) +
  labs(x = "Year", y = "Money spent on players per team in million US$",
       title = "Money spent on players per team (5 most paying teams)")
div(ggplotly(sal_mostp_teams_sum), align = "center")
#plotting the average salary
sal_mostp_teams_mean <- 
  ggplot(data = mostpaying_teams_dev) + 
  geom_line(mapping = aes(x = yearID, y = salary_mean, color = teamID)) + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_color_manual(values = c("#A7C4E3", "#74a9cf", "#4B88C8", "#446a8b", "#323135")) +
  scale_x_continuous(breaks = sal_bb_stats_lg$yearID) +
  labs(x = "Year", y = "Mean salary paid per team in million US$",
       title = "Mean salary paid per team (5 most paying teams)")
div(ggplotly(sal_mostp_teams_mean), align = "center")
```
  
###Mostpaying teams - do they win more? 
For the teams, we also want to analyze if the teams paying high salaries for their players also win the most. For this we will use the Wins per Games from the Age table. The tables are joined together by a left_join. 

```{r sal_teams_prep}
salaries16_teams <- salaries16 %>%
  group_by(teamID) %>%
  summarise(n_players = n(), 
            sal_min = min(salary),
            sal_max_prop = max(salary)/sum(salary),
            sal_median = median(salary),
            sal_mean = mean(salary),
            sal_sum = sum(salary))
salaries16_teams_games <- inner_join(salaries16_teams,  
                                    (Teams %>% filter(yearID == age_current) %>% 
                                               select(teamID,G, W, L) %>% 
                                               mutate(Wprop = W/G)),
                                     "teamID")
salaries16_teams_games
(anti_join((Teams %>% filter(yearID == age_current) %>% 
                      select(teamID,G, W, L)) %>% 
                      mutate(Wprop = W/G), salaries16_teams, "teamID"))
            
(anti_join(salaries16_teams, 
           (Teams %>% filter(yearID == age_current) %>% 
                      select(teamID,G, W, L) %>% 
                      mutate(Wprop = W/G)), 
           "teamID"))
```
  
####Salary and Win proportion

Then we construct the linear model with our formula. We look at the median, maximum and sum spent. 
  
```{r sal_teams_wprop}
#linear model for the median salary per team
salaries16_teams_med <- lm_own(salaries16_teams_games, "Wprop", "sal_median", 
                               "% Games won", "Median player's salary in million US$ per team", "Linear model of the % Games won \n
                               and median salary per team")
(salaries16_teams_med)
#linear model for the maximum salary per team 
salaries16_teams_max_prop <- lm_own(salaries16_teams_games, "Wprop", "sal_max_prop", 
                                    "% Games won", "Proportion of Maximum player's salary in million US$ per team", "Linear model of the % Games won \n
                                    and proportion of maximum salary per team")
(salaries16_teams_max_prop)
#linear model for the sum of salaries paid per team 
salaries16_teams_sum <- lm_own(salaries16_teams_games, "Wprop", "sal_sum", 
                               "% Games won", "Money spent on players in million US$ per team", "Linear model of the % Games won \n
                               and Money spent on players per team")
(salaries16_teams_sum)
```
  
####Win proportion and Salary

```{r sal_teams_sal_wprop}
#linear model for the median salary per team
salaries16_wprop_med <- lm_own(salaries16_teams_games, "sal_median", "Wprop", "Median player's salary in million US$ per team", "% Games won", "Linear model of the median salary per team and % Games won")
(salaries16_wprop_med)
#linear model for the maximum salary per team 
salaries16_wprop_max_prop <- lm_own(salaries16_teams_games, "sal_max_prop", "Wprop", "Proportion of Maximum player's salary in % per team", "% Games won", "Linear model of the proportion of maximum salary per team and % Games won")
(salaries16_wprop_max_prop)
#linear model for the maximum salary per team 
salaries16_wprop_max_prop <- lm_own(salaries16_teams_games, "sal_max_prop", "Wprop", "Proportion of Maximum player's salary in % per team", "% Games won", "Linear model of the proportion of maximum salary per team and % Games won")
(salaries16_wprop_max_prop)
#linear model for the sum of salaries paid per team 
salaries16_wprop_sum <- lm_own(salaries16_teams_games, "sal_sum", "Wprop", "Money spent on players in million US$ per team", "% Games won", "Linear model of the Money spent on players per team and % Games won")
(salaries16_wprop_sum)
```

#Of Age, Salaries and Handedness
The last chapter looks at all the factors described above, and figures out the relation between age, salary and handedness and the baseball-player's success. The sucess of a baseball player is measured by the Wins Above Replacement (WAR). 

##Linear Model
For our final linear model we entered all of the variables above as covariates to predict a player's expected weighted WAR. Also, we included an interaction term for age and salary. The rationale behind this is that we suspected the strength of the relationship between salary and weighted WAR to vary as a function of age. More precisely, younger players who are under their first contract could be relatively important to their teams, however get paid relatively less as opposed to older players who are beyond their first contract. That is, we consider it reasonable to suspect that older, established players (beyond their first contract) are paid according to their actual performance, whereas younger players are paid according to their presumed potential. We also included handedness as a covariate, with a player's throwing hand as a proxy for "handedness".  

The model:
```{r}
#Add column age to the salaries16_pl_warPos data frame
df16 <- inner_join(salaries16_pl_warPos, age_c_players, by = c("playerID","teamID"))

#linear model contains a player's throwing hand, his age, his salary, and the
#interaction between age and salary
finalModel <- lm(weightedWAR~throws+age+salary+age*salary, data=df16)
```

$$
\widehat{\text{weighted WAR}}_i = \widehat{\beta}_0+\widehat{\beta}_1\text{Left}_i+\widehat{\beta}_2\text{Age}_i+\widehat{\beta}_3\text{Salary}_i+\widehat{\beta}_4\text{Age}_i\times\text{Salary}_i
$$   
```{r results="asis"}
stargazer(finalModel, align = T , type="html") #display summary statistics
```  
<br><br> 

Unsurprisingly (and in light of the previous linear models) our final model does not "explain" the data very well ($R^2$ < .06).   

To visualize the observed data, we created a 3-D scatter plot, with age and salary on the x- and y-axes, and weighted WAR on the z-axis. We used different colors in order to distinguish between the two handedness groups.

```{r}
#define scatter plot for left-handed players as a plolty object 
observed_left <- plot_ly(
    filter(df16, throws=="Left"), color = ~throws #required to assign color
    ) %>% 
  add_markers( #add_markers is comparable to geom_point()
    name = "Left-Handed Observed", #names the plotly object
    x = ~age, 
    y = ~salary,
    z = ~weightedWAR,
    colors = "orangered2",
    size = .5
  )

#define scatter plot for right-handed players as a plolty object 
observed_right <- plot_ly(filter(df16, throws == "Right"), x = ~age, y=~salary, z=~weightedWAR, color = ~throws
    ) %>% 
  add_markers(
    name = "Right-Handed Observed",
    x = ~age,
    y = ~salary,
    z = ~weightedWAR,
    colors = "limegreen",
    size = .5
  )

#subplot merges two plotly objects (here: observed_left, and observed_right)
#function div() is used to center the scatter plot
div(subplot(observed_left, observed_right) %>% 
  layout( #layout is used to specify titel and axis labels
    title = 
      "Observed Weighted WAR by Age, Salary and Handedness",
    scene = list(
      xaxis = list(title = "Age"),
      yaxis = list(title = "Salary"),
      zaxis = list(title = "Weighted Wins Above Replacement"))
  ), align="center")
```

To visualize the linear trend fitted by our model, we plotted two separate regression planes, one for each handedness group.

```{r}
age_grid <- seq_range(df16$age,10) #specify x values for the surface grid
salary_grid <- seq_range(df16$salary, 10) #speciy y values for the surface grid

#returns a matrix of fitted values for right-handed players
fit_right <- outer(
  age_grid,
  salary_grid,
  #FUN is the equation of the linear model for right-handed players.
  #Right-handed is coded as 0.
  ##Coefficients are taken from the final model's summary table.
  FUN = function(age_grid, salary_grid) { 
    finalModel$coefficients[[1]]+
      finalModel$coefficients[[3]]*age_grid+
      finalModel$coefficients[[4]]*salary_grid+
      finalModel$coefficients[[5]]*age_grid*salary_grid
  }
)

#returns a matrix of fitted values for left-handed players
fit_left <- outer(
  age_grid,
  salary_grid,
  #FUN is the equation of the linear model for left-handed players. 
  #Left-handed is coded as 1.
  #Coefficients are taken from the final model's summary table.
  FUN = function(age_grid, salary_grid){
    finalModel$coefficients[[1]]+
      finalModel$coefficients[[2]]+
      finalModel$coefficients[[3]]*age_grid+
      finalModel$coefficients[[4]]*salary_grid+
      finalModel$coefficients[[5]]*age_grid*salary_grid
  }
)

#Creates a regression surface for left-handed players as a plotly object
surface_left <- 
  plot_ly() %>% 
  add_surface(
    x = ~age_grid,
    y = ~salary_grid,
    z = ~fit_left,
    name = "Left-Handed",
    colors = "OrRd",
    colorbar=list(title='Fitted WAR for Left-Handed Players')
  )

#Creates a regression surface for right-handed players as a plotly object
surface_right <- 
  plot_ly(color = ~fit_right) %>% 
  add_surface(
    x = ~age_grid,
    y = ~salary_grid,
    z = ~fit_right,
    name = "Right-Handed",
    colors = "Greens",
    colorbar=list(title='Fitted WAR for Right-Handed Players')
  ) 

#Subplot merges the two regression plane into a single plotly object
div(subplot(surface_left, surface_right) %>% 
  layout(
    title = 
      "Fitted WAR For The Interaction Between 
           Age And Salary By Handedness",
    scene = list(
      xaxis = list(title = "Age"),
      yaxis = list(title = "Salary"),
      zaxis = list(title = "Weighted Wins Above Replacement"))
  ), align="center")
```

We also plotted the residuals against our covariates (plus the interaction term) to see if there's any remaining trend in our data not accounted for by the model (presumably there is). 

```{r}
#Add predicted values and residuals to df16
df16 <- df16 %>% 
  add_residuals(finalModel) %>% 
  add_predictions(finalModel)

#returns residual plot for handedness
(p_resid_hand <- df16 %>% 
  ggplot(aes(throws, resid))+
  geom_point()+
  ggtitle("Residuals By Handedness")+
  xlab("Salary")+
  ylab("Residuals"))

#returns residual plot for age
(p_resid_age <- df16 %>% 
  ggplot(aes(age, resid))+
  geom_point()+
  facet_wrap(~throws)+ #show separate plots for each handedness group
  ggtitle("Residuals By Age And Handedness")+
  xlab("Age")+
  ylab("Residuals"))

#returns residual plot for salary
(p_resid_salary <- df16 %>% 
  ggplot(aes(salary, resid))+
  geom_point()+
  facet_wrap(~throws)+
  ggtitle("Residuals By Salary And Handedness")+
  xlab("Salary")+
  ylab("Residuals"))

#returns residual plot for age and salary interaction
(p_resid_age_salary <- df16 %>% 
  ggplot(aes(age*salary, resid))+
  geom_point()+
  facet_wrap(~throws)+
  ggtitle("Residuals By Age-By-Salary And Handedness")+
  xlab("Age-by-Salary")+
  ylab("Residuals"))
```
The scatter plots for age/salary/age-by-salary and the residuals look nothing like random noise. It is most likely that there is a pattern in the data that was not captured by our model. 

##Appended Code 



```{r}
# threeD <- function(df){
#   models <- list()
#   models <- list(
#     batsRight <- list(df[df[["bats"]]=="Right",]),
#     batsLeft <- list(df[df[["bats"]]=="Left",]),
#     batsBoth <- list(df[df[["bats"]]=="Both",]),
#     throwsLeft <- list(df[df[["throws"]]=="Left",]),
#     throwsRight <- list(df[df[["throws"]]=="Right",])
#   )
#   for (i in seq_along(models)){
#     models[[i]][2] <- lapply(
#       models[[i]][1], function(x){
#         lm(weightedWAR~age*salary, data=x)
#       }
#     )
#   }
#   for(i in seq_along(models)){
#     models[[i]][[3]] <- list(
#       x = seq_range(na.omit(models[[i]][[1]][["age"]]), 10),
#       y = seq_range(na.omit(models[[i]][[1]][["salary"]]),10),
#       z = outer(seq_range(na.omit(models[[i]][[1]][["age"]]), 10), 
#                 seq_range(na.omit(models[[i]][[1]][["salary"]]),10), 
#                 FUN = predictSurface, model = models[[i]][[2]])
#     )
#   }
#   name <- 
#     c("Right-Handed Batters", "Left-Handed Batters", 
#       "Both-Handed Batters", "Left-Handed Throwers", 
#       "Right-Handed Throwers")
#   names(models) <- name
#   for (i in seq_along(models)){
#     models[[i]]$plot <- plot_ly(models[[i]][[1]], x=~age, y=~salary, z=~weightedWAR) %>% 
#       add_surface(
#         x = ~models[[i]][[3]]$x,
#         y = ~models[[i]][[3]]$y,
#         z = ~models[[i]][[3]]$z
#       ) %>% 
#       add_markers(
#         marker = list(color = "#446A8B", symbol = "circle", size = 4)
#       ) %>% 
#       layout(
#         title = paste0("Interaction Between Age and Salary for ",name[i]),
#         scene = list(
#           xaxis = list(title = "Age"),
#           yaxis = list(title = "Salary"),
#           zaxis = list(title = "Weighted Wins Above Replacement"))
#       ) 
#       
#   }
#   models
# }
# 
# div(threeD(df16)$'Right-Handed Throwers'$plot, align = "center")

```
