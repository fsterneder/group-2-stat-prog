---
title: "Baseball â€“ Of Ages, Salaries and Handedness"
subtitle: "Programming in Statistics - Project"
author: "Vilsmeier Johannes, Sterneder Florian, Schaub Andrea"
date: '`r Sys.Date()`'
output:
  html_document:
    code_folding: hide
    css: rstyle.css
    number_sections: yes
    theme: cosmo
    highlight: tango
    toc: yes
    toc_float: yes
---

```{r hide=T, warning=F, message=F}

library(knitr)
library(shiny)
opts_chunk$set(echo = TRUE,
               collapse = TRUE,
               comment = "",
               strip.white = TRUE,
               warning = FALSE,
               messages = FALSE,
               fig.align = "center")
source("help.R")
theme_set(theme_light())
```  


```{r war_stats}
#quick look at warPos table
glimpse(warPos)

#choosing the relevant columns
warPos <- warPos %>%
  subset(select = c(year_ID, lg_ID, team_ID, player_ID, age, WAR))
colnames(warPos) <- c("yearID", "lgID", "teamID", "playerID", "age", "WARpos")
#warPos was parsed as chr, fixing this with as.double
warPos$WARpos <- as.double(warPos$WARpos)

#making the warpos file for only 2016
warPos16 <- warPos %>%
  filter(yearID == 2016) %>%
  #na's are going to be removed
  filter(is.na(WARpos) == F)


warPit <- warPit %>%
  subset(select = c(year_ID, lg_ID, team_ID, player_ID, age, WAR))
colnames(warPit) <- c("yearID", "lgID", "teamID", "playerID", "age", "WARpit")
#warPit was also parsed as chr, fixing this with as.double
warPit$WARpit <- as.double(warPit$WARpit)

#making the warPit file for only 2016
warPit16 <- warPit %>%
  filter(yearID == 2016) %>%
  #na's are going to be removed
  filter(is.na(WARpit) == F)
```

# Of Age and Baseball
The first chapter analyzes the age of baseball players, focusing on the ones of 2016. First the average age is computed, then differences between the teams in their average players age are analyzed. At the end of this chapter, the questions "How old is a good baseball player?" or "Do they get better with age?" will be answered.   

##Age of the average active baseball player in 2016

```{r}
age_calc <- function(from,to=now()) floor(difftime(to, from)/dyears(1))
age_year = 2016
age_const = paste0(age_year,"0403")

age_c_players <- 
    left_join(Appearances %>% filter(yearID == age_year), People, "playerID") %>%
    mutate(birthDate = as_date(ymd(paste(birthYear, birthMonth, birthDay, sep = "-")))) %>%
    mutate(age = age_calc(birthDate, ymd(age_const))) %>%
    select(playerID, teamID, birthDate, age, nameFirst, nameLast, G_all, GS) 
```

We define active as in played in season `r age_year`. Also we calculate the age with the start of the season (April 3rd).

We find that the average active professional baseball player , in the season of `r age_year`, was born `r mean(age_c_players$birthDate)` and was therefore `r age_calc(mean(age_c_players$birthDate),ymd(age_const))` years old. 

Let's visualize that.

```{r}
age_players_1 <- age_c_players %>% 
    ggplot(aes(x = age)) +
    geom_line(stat = "density") + 
    geom_vline(aes(xintercept = mean(age)), alpha = 0.5, color = "#3068A1")

div(ggplotly(age_players_1), align = "center")
```

Funfact: As we might be able to tell from the graph, the oldest player in the season of `r age_year` was `r age_calc(min(age_c_players$birthDate),ymd(age_const))`.

Now we know more about the average active player in `r age_year`. Let's go further.

##Differences in the age distribution per team

```{r}
names(color$team_main) <- sort(unique(age_c_players$teamID))

age_c_team <- age_c_players %>% 
   group_by(teamID) %>%
   summarise(meanAge = mean(age), medianAge = median(age)) %>%
   left_join(Teams %>% filter(yearID == age_year) %>% select(teamID,name,W,L,G), by = "teamID")
 
age_players_team_1 <- age_c_team %>% 
    ggplot(aes(reorder(teamID,meanAge), meanAge, color = teamID)) +
    geom_point(size = 2) + 
    scale_color_manual(values = color$team_main) +
    guides(color = FALSE) + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    coord_flip()
div(ggplotly(age_players_team_1), align = "center")
```
So now we know that the the team with the - on average - youngest players are the `r (age_c_team %>% filter(meanAge == min(meanAge)))$name` while the `r (age_c_team %>% filter(meanAge == max(meanAge)))$name` deploys - again, on average - the oldest players. But the difference between these 'extremes' is `r signif(max(age_c_team$meanAge) - min(age_c_team$meanAge),3)` and in my view not that siginificant. 

We still want to know more, let's look at the related boxplot.

```{r}
age_players_team_2 <- age_c_players %>% 
    left_join(age_c_team, by = "teamID") %>%
    ggplot(aes(reorder(teamID,meanAge),age,color = teamID)) +
    geom_boxplot(notch = TRUE) +
    scale_color_manual(values = color$team_main) +
    guides(color=FALSE) + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    coord_flip()
div(ggplotly(age_players_team_2), align = "center")
```
As we see, the IQR and Median isn't _that_ different between the teams. Maybe we can work out larger differences in the next question.

##Weighted average team age

The idea is to weight the playing time of each player and therefore see if teams rather put their faith in younger players or value experience. The formula we use to weigh each time is $$ \text{age}_p \frac{\text{games played}_p}{\frac{1}{n}\sum^n_{i=1}\text{games played}_i} $$

```{r}
age_c_team <- 
   left_join(
             age_c_players,
             (Teams %>% filter(yearID == age_year) %>% select(teamID,G, W, L)),
             "teamID"
            ) %>%
   group_by(teamID) %>% 
   add_count() %>%
   mutate(G_avg = mean(G_all),GS_avg = mean(GS)) %>%
   mutate(gProp = age*(G_all/G_avg), gsProp = age*(GS/GS_avg)) %>%
   summarise(weightByG = mean(gProp), weightByGS = mean(gsProp)) %>%
   left_join(age_c_team, "teamID")

#kable(sample_n(age_c_team,5), format="markdown")

age_players_team_3 <- age_c_team %>% 
    ggplot(aes(reorder(teamID, meanAge), weightByG, color = teamID)) +
    geom_point(aes(reorder(teamID, meanAge), meanAge, color = teamID), size = 0.8) +
    geom_point(size = 2) + 
    scale_color_manual(values = color$team_main) +
    geom_segment(aes(xend = teamID, yend = meanAge)) +
    guides(color = FALSE) + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) + 
    coord_flip()
div(ggplotly(age_players_team_3), align = "center")
```

As we can can see, there are some differences if we weight the playing time, but most noticeable to me is that the shift is clearly toward more experienced players. To be exact, according to this new metric the average team is now `r signif(age_c_team %>% summarise(mean(weightByG-meanAge)),4)` years older which adds up to `r signif(age_c_team %>% summarise(sum(weightByG-meanAge)),4)` years in total for the whole league.

##Linear Model - performance and average team age

```{r}
age_c_team <- age_c_team %>% mutate(Wprop = W/G)
age_perf_mod <- lm(data=age_c_team, formula= Wprop ~ weightByG)
age_c_team <- age_c_team %>% add_predictions(age_perf_mod) %>% add_residuals(age_perf_mod)

age_lm_1 <- age_c_team %>% 
  ggplot(aes(weightByG)) + geom_point(aes(y=Wprop)) + geom_line(aes(y=pred),color="#3068A1")
div(ggplotly(age_lm_1), align = "center")

age_lm_2 <- age_c_team %>% 
  ggplot(aes(resid)) + geom_freqpoly(binwidth=0.04)
div(ggplotly(age_lm_2), align = "center")

age_lm_3 <- age_c_team %>% 
  ggplot(aes(weightByG, resid)) + geom_point()
div(ggplotly(age_lm_3), align = "center")
```

```{r results="asis"}
stargazer(age_perf_mod, align=T, type='html')
```
#Text needed on lm age :) 
#Text/Analysis needed on Performance of individuals as they age 
##Performance of individuals as they age

# Of Salaries and Baseball
After looking at the average age of baseball players, we take a look on what they earn. Is it more/less depending on the league? How is the development compared to the average US-salary? After answering these questions, the mostpaid players and mostpaying teams in the 2000s are also listed. The main question, if a good baseball player also gets paid high, is asked at the end. 

###Adjusting the statistics
Before starting the analysis, we have to prepare our data. For the salaries, we have one table containing the average US-salaries from 1989-2017, and another table containing all baseball-players' salaries from 1989-2016. 

####US-Salaries
The statistics for the average wage in the US came from the OECD (https://data.oecd.org/earnwage/average-wages.htm#indicator-chart). Unfortunately, we didn't find more accurate data for the wages than the average. Be careful with interpreting the numbers, as with wages, the mean and the median differ a lot. 
Within the dataset some columns were dropped, and the average development in percent was calculated. 
```{r salaries_us_adjust}
#renaming the columns
colnames(Salaries_US) = c("country", "indicator", "subject", "currency", "frequency", "yearID", "av_wage_US", "Flag_codes")
Salaries_US <- Salaries_US %>%
  #dropping columns
  subset(select = -c(country, indicator, subject, frequency, Flag_codes)) %>%
  #calculating average development
  mutate(av_wage_US = av_wage_US/1000000,
         av_wage_perc = ((av_wage_US/lag(av_wage_US) - 1) * 100),
         av_wage_100perc = ((av_wage_US-min(av_wage_US))/max(av_wage_US)))
(Salaries_US)
```
  
####Baseball-Salaries
With the baseball salaries, some statistical values, like mean, max, min and median were calculated. Also the average development of the mean salary was computed to compare it to the US salaries. 
```{r salaries_adjust}
Salaries <- Salaries %>%
  mutate(salary = salary/1000000)
(Salaries)

sal_bb_stats <- Salaries %>%
  group_by(yearID) %>%
  summarise(n_players = n(), 
            n_teams = n_distinct(teamID),
            n_dist_players = n_distinct(playerID),
            salary_mean = mean(salary),
            salary_max = max(salary),
            salary_min = min(salary),
            salary_median = quantile(salary, probs = 0.5))
sal_bb_stats
#
sal_bb_stats_90 <- sal_bb_stats %>%
  filter(yearID >= 1990) %>%
  mutate(salary_mean_perc = ((salary_mean/lag(salary_mean) - 1) * 100),
         salary_mean_100perc = ((salary_mean-min(salary_mean))/max(salary_mean))) 
```
  
##Overview
The boxplot shows the median salary, and the first and third quantile. There are a lot of outliers, the mean salary is also shown. In 2000 there was a leap in the median salary, and in and after 2009, the highest salaries so far were payed. We're going to take a look at that afterwards. 
The number of players and teams was also analyzed, to find out about missing data. Explicitly missing data is not stored in the tables we have, but there seems to be implicitly missing data. The number of players spikes a lot through the years, and there are also players, who got paid by more than one team a year, which can be seen in the difference between the number of players and the distinct number of players per year. As this analysis is about average salaries, we will keep all the data, because wheter somebody was paid twice or once does not matter. They played more, so they earned more. 

```{r salaries_statistics}
summary(Salaries)

#boxplot with the player salaries
sal_boxplot <- ggplot() + 
  geom_boxplot(data = Salaries, aes(x = yearID, y = salary, group = cut_width(yearID, 1)), alpha = 0.5) + 
  geom_line(data = sal_bb_stats, aes(x = yearID, y = salary_mean), color = "#3068A1") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = Salaries$yearID) +
  labs(x = "Year", y = "Salary in million US$", 
       title = "Baseball-players' Salaries") 
(sal_boxplot)

#graph with number of players per year
sal_bb_nbplayers <- ggplot(data = sal_bb_stats) + 
  geom_line(mapping = aes(x = yearID, y = n_dist_players), color = "#384F5d") +
  geom_line(mapping = aes(x = yearID, y = n_players), color = "#3068A1") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = Salaries$yearID) +
  labs(x = "Year", y = "Number of players", 
       title = "Number of players with salary information each year")
div(ggplotly(sal_bb_nbplayers), align = "center")

#graph with number of teams per year
sal_bb_nbteams <- ggplot(data = sal_bb_stats, mapping = aes(x = yearID, y = n_teams)) + 
  geom_line(color = "#3068A1") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = Salaries$yearID) +
  labs(x = "Year", y = "Number of teams", 
       title = "Number of Teams with salary information each year")
div(ggplotly(sal_bb_nbteams), align = "center")
```

##Within the leagues
Let's focus on the differences within the leagues. We have 2 leagues within the salaries data, the National League (NL) and the American League (AL). In the scatterplot we see, that the differences between the average salary and maximum salary grow with time, so this is not caused by any league paying highly more, although there are differences: The maximum gaining players of the NL earn more money than the ones from the AL (except for 2015 and 2016). 
But over the average salaries, the AL pays more. 
So if you're good, go the the AL - if you're the best, go to the NL. 
The range, which tells us about the gap between the min and max salary of the players rose over time, and here we can see, that the least paid player gets a lot less compared to the maximum paid player in the AL than in the NL. 
```{r salaries_lg}
#computing the stats for leagues 
sal_bb_stats_lg <- Salaries %>%
  group_by(yearID, lgID) %>%
  summarise(n_players_lg = n(), 
         salary_lg_mean = mean(salary),
         salary_lg_max = max(salary),
         salary_lg_min = min(salary),
         salary_lg_median = quantile(salary, probs = 0.5)) %>%
  mutate(salary_lg_100perc = (salary_lg_mean-min(salary_lg_mean)/max(salary_lg_mean)))
(sal_bb_stats_lg)

#graph with the salaries, grouped by league
sal_lg <- 
  ggplot(data = Salaries, mapping = aes(x = yearID, y = salary)) + 
  geom_point(mapping = aes(color = lgID), alpha = "0.3", position = "jitter") + 
  geom_smooth(method='lm', se=F, color = "#93adc8") + 
  scale_color_manual(values=c("#446a8b", "#985c59")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = sal_bb_stats_lg$yearID) +
  labs(x = "Year", y = "Salary in million US$",
       title = "Baseball-players' salaries, grouped by league")
(sal_lg)

#graph with number of players per year and league
#ggplot(data = sal_bb_stats_lg, mapping = aes(x = yearID, y = n_players_lg)) + 
  #geom_line(mapping = aes(color = lgID))+ 
  #theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  #scale_x_continuous(breaks = sal_bb_stats_lg$yearID) +
  #labs(x = "Year", y = "Number of players")

#graph with median and mean salary per year and league
sal_bb_stats_lg_all <- sal_bb_stats_lg %>%
  gather(key="statistics_type", value = "salary", salary_lg_mean, salary_lg_median) %>%
  ggplot(mapping = aes(shape = lgID), size = 10) +
  geom_line(mapping = aes(x = yearID, y = salary, color = lgID)) +
  scale_color_manual(values=c("#446a8b", "#985c59")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = sal_bb_stats_lg$yearID) +
  labs(x = "Year", y ="Salary (median, mean) in million US$",
       title = "Median and mean salary per year and league")
(sal_bb_stats_lg_all)+facet_wrap(vars(statistics_type), nrow=2)

#Range of bb salaries in leagues
sal_bb_stats_lg_range <- 
  ggplot(data = sal_bb_stats_lg, mapping = aes(color = lgID)) +
  geom_line(mapping = aes(x = yearID, y = salary_lg_max-salary_lg_min)) +
  scale_color_manual(values=c("#446a8b", "#985c59")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = sal_bb_stats_lg$yearID, labels = scales::comma) +
  labs(x = "Year", y = "Range of salaries in mllion US$", 
       title = "Range of baseball players' salaries by league")
div(ggplotly(sal_bb_stats_lg_range), align = "center")
```

##Compared to US-salaries
The average baseball salaries increased a lot with time. Let's compare it to the average US salaries and see if they rose alike. 
We can see, that the average salary of baseball players is a lot higher. To see the differences more, we compare the percentage rise over time. Starting at 1990 (because the US Salary data is not available for the years before), the average US wages increased about 25% until 2016, whereas the baseball players' salaries increased more than 85%. This is a huge difference. So, baseball probably became more popular or at least, people want to spend more on the games and the teams, the teams might have more money because of bigger sponsoring and so on. 

```{r salaries_comparison_us}
sal_bb_us <- left_join(sal_bb_stats_90, Salaries_US, by = "yearID")
(sal_bb_us) 

#graph with average salaries per year for bb
sal_bb_us_av <- 
  ggplot(data = sal_bb_us) + 
  geom_point(mapping = aes(x = yearID, y = salary_mean), color = "#446A8B") + 
  geom_smooth(mapping = aes(x = yearID, y = salary_mean), color = "#748CA1", method='lm', se=F) + 
  geom_point(mapping = aes(x = yearID, y = av_wage_US), color = "#555822") + 
  geom_smooth(mapping = aes(x = yearID, y = av_wage_US), color = "red", method='lm', se=F) + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = sal_bb_us$yearID) +
  labs(x = "Year", y = "Average salary in million US$", 
       title = "Average salary of baseballers and US citizens")
div(ggplotly(sal_bb_us_av), align = "center")

sal_bb_us_dev <- ggplot(data = sal_bb_us) + 
  geom_point(mapping = aes(x = yearID, y = salary_mean_100perc), color = "#446A8B") + 
  geom_smooth(mapping = aes(x = yearID, y = salary_mean_100perc), color = "#748CA1", method='lm', se=F) + 
  geom_point(mapping = aes(x = yearID, y = av_wage_100perc), color = "#555822") + 
  geom_smooth(mapping = aes(x = yearID, y = av_wage_100perc), color = "#D0D75F", method='lm', se=F) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = sal_bb_us$yearID) +
  labs(x = "Year", y = "Percentage rise in salary of baseballers and US citizens", 
       title = "Salarydevelopment of baseballers and US citizens")
div(ggplotly(sal_bb_us_dev), align = "center")
```
  
##Mostpaid players and mostpaying teams

The rise in the salaries was mainly conducted by some high earninig players - why do they get paid so much more than others? Are they better? To answer these questions the players with the largest salaries each year (after 2000, because after that year, the gap was getting a lot bigger) were chosen for further analysis. 
```{r salaries_mostp_pl_teams}
salary_max <- Salaries %>%
  filter(yearID > 1999) %>%
  group_by(yearID) %>%
  mutate(max_salary = max(salary)) %>%
  subset(salary == max_salary) %>%
  ungroup()
(salary_max)

mostpaid_players <- salary_max %>%
  group_by(playerID) %>%
  summarise(mostpaid_player = n()) %>%
  ungroup()
(mostpaid_players)

mostpaying_teams <- salary_max %>%
  group_by(teamID) %>%
  summarise(mostpaying_team = n())
(mostpaying_teams)

sal_mostp_pl <- Salaries %>%
  filter(playerID %in% c(salary_max$playerID))
(sal_mostp_pl)

sal_mostp_team <- Salaries %>%
  filter(teamID %in% mostpaying_teams$teamID)
(sal_mostp_team)

```

###Mostpaid players

The two most earning players in 2015 and 2016 (Greinza01 and Kershcl01) were quite new in the game, whereas rodrial01 was the mostpaid player for a long time. Brownke01, playing until 2005, had a long career before he was most paid. After getting most money, he didnt develop anymore, his salary stayed the same. Giambja01 and Ramirma01 had a similar development in salary, with Ramirma01 getting less between 2007 and 2009 and then earning more again. 
```{r salaries_mostpaid_players}
sal_mostp_pl_all <- 
  ggplot(data = sal_mostp_pl, mapping = aes(x = yearID, y = salary)) + 
  geom_line(mapping = aes(color = playerID)) + 
  geom_point(mapping = aes(color = playerID))+
  scale_color_manual(values = c("#93adc8", "#74a9cf", "#4B88C8", "#0570b0", "#446a8b", "#323135")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = sal_bb_stats_lg$yearID) +
  labs(x = "Year", y = "Salary per player in million US$", 
       title = "Salaries of the mostpaid baseball-players over time")
ggplotly(sal_mostp_pl_all)
```
Let's also take a look at the most paid players in 2016. Were they also the best at playing? A linear model will tell us more, but first we need to prep our data. We filter the salaries table for data on 2016. 

```{r}
salaries16 <- Salaries %>%
  filter(yearID == 2016)

salaries16_pl_warPos <- left_join(salaries16, warPos16, "playerID")
sal_anti_1 <- anti_join(salaries16, warPos16, "playerID")
sal_anti_2 <- anti_join(warPos16, salaries16, "playerID")
(sal_anti_1)
(sal_anti_2)

lm_salaries16_pl_warpos <- lm(data=salaries16_pl_warPos, formula= salary ~ WARpos)

#linear model for the median salary per team
salaries16_pl_pos_lm <- salaries16_pl_warPos %>% 
  add_predictions(lm_salaries16_pl_warpos) %>% add_residuals(lm_salaries16_pl_warpos)

salaries16_pl_pos_lm_plot <- salaries16_pl_pos_lm %>% 
  ggplot(aes(WARpos)) + 
  geom_point(aes(y=salary)) + 
  geom_line(aes(y=pred),color="#3068A1") + 
  labs(y = "Salary", x = "WAR (position)", 
       title = "Linear model of the salary and Wins above replacement for position players in 2016")
div(ggplotly(salaries16_pl_pos_lm_plot), align = "center")
```

```{r}
warPit16
salaries16_pl_warPit <- inner_join(salaries16, warPit16, "playerID")
sal_anti_1 <- anti_join(salaries16, warPit16, "playerID")
sal_anti_2 <- anti_join(warPit16, salaries16, "playerID")
(sal_anti_1)
(sal_anti_2)

lm_salaries16_pl_warpit <- lm(data=salaries16_pl_warPit, formula= WARpit ~ salary)


lm_own <- function(df, y1, x1, txt_x = "Salary", txt_y = "WAR", txt_title = "Your title here") {
  lm_df <- lm(data = df, formula = y1 ~ x1)
  df1 <- df %>%
    add_predictions(lm_df) %>%
    add_residuals(lm_df)
  lm_df_plot <- df1 %>%
    ggplot(aes(x1)) +
    geom_point(aes(y=y1)) +
    geom_line(aes(y=pred), color = "#3068A1") + 
    labs(x = txt_x, y = txt_y, title = txt_title)
  div(ggplotly(lm_df_plot), align = "center")
}

lm_sal16_pl_warpit_sal = lm_own(salaries16_pl_warPit, WARpit, salary, "S", "y", "my title")

#linear model for the salary and WAR (pitching)
salaries16_pl_pit_lm <- salaries16_pl_warPit %>% 
  add_predictions(lm_salaries16_pl_warpit) %>% add_residuals(lm_salaries16_pl_warpit)

salaries16_pl_pit_lm_plot <- salaries16_pl_pit_lm %>% 
  ggplot(aes(salary)) + 
  geom_point(aes(y=WARpit)) + 
  geom_line(aes(y=pred),color="#3068A1") + 
  labs(x = "Salary", y = "WAR (pitching)", 
       title = "Linear model of the salary and Wins above replacement for pitching in 2016")
div(ggplotly(salaries16_pl_pit_lm_plot), align = "center")
```

###Mostpaying teams
```{r salaries_mostpaying_teams}
sal_mostp_team_stat <- sal_mostp_team %>%
  group_by(yearID, teamID) %>%
  summarise(n_players = n(), 
         salary_mean = mean(salary),
         salary_max = max(salary),
         salary_min = min(salary),
         salary_median = quantile(salary, probs = 0.5)) %>%
  mutate(salary_100perc = (salary_mean-min(salary_mean)/max(salary_mean)))
div(ggplotly(sal_mostp_team_stat), align = "center")

sal_mostp_teams_all <- 
  ggplot(data = sal_mostp_team_stat) + 
  geom_line(mapping = aes(x = yearID, y = salary_max, color = teamID)) + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_color_manual(values = c("#93adc8", "#0570b0", "#446a8b", "#323135")) +
  scale_x_continuous(breaks = sal_bb_stats_lg$yearID) +
  labs(x = "Year", y = "Maximum salary per team in million US$",
       title = "Maximum salary paid per team (4 highest paying teams)")
div(ggplotly(sal_mostp_teams_all), align = "center")

```
For the teams, we also want to analyze if the teams paying high salaries for their players also win the most. For this we will use the Wins per Games from the Age table. The tables are joined together by a left_join. 

```{r}
salaries16_teams <- salaries16 %>%
  group_by(teamID) %>%
  summarise(n_players = n(), 
            sal_min = min(salary),
            sal_max = max(salary),
            sal_median = median(salary),
            sal_mean = mean(salary),
            sal_sum = sum(salary))

salaries16_teams_games <- left_join(salaries16_teams,  
                              (Teams %>% filter(yearID == age_year) %>% 
                                         select(teamID,G, W, L)) %>% 
                                         mutate(Wprop = W/G),
                              "teamID")

salaries16_teams_med_lm <- lm(data=salaries16_teams_games, formula= Wprop ~ sal_median)
salaries16_teams_max_lm <- lm(data=salaries16_teams_games, formula= Wprop ~ sal_max)
salaries16_teams_sum_lm <- lm(data=salaries16_teams_games, formula= Wprop ~ sal_sum)


#linear model for the median salary per team
salaries16_teams_med <- salaries16_teams_games %>% 
  subset(select = -c(sal_min, sal_max, sal_mean, sal_sum, G, W, L)) %>%
  add_predictions(salaries16_teams_med_lm) %>% add_residuals(salaries16_teams_med_lm)

salaries16_lm_med <- salaries16_teams_med %>% 
  ggplot(aes(sal_median)) + 
  geom_point(aes(y=Wprop)) + 
  geom_line(aes(y=pred),color="#3068A1") + 
  labs(x = "Median player's salary in million US$ per team", y = "% Games won", 
       title = "Linear model of the median salary per team and % Games won")
div(ggplotly(salaries16_lm_med), align = "center")


#linear model for the maximum salary per team 
salaries16_teams_max <- salaries16_teams_games %>% 
  subset(select = -c(sal_min, sal_median, sal_mean, sal_sum, G, W, L)) %>%
  add_predictions(salaries16_teams_max_lm) %>% add_residuals(salaries16_teams_max_lm)

salaries16_lm_max <- salaries16_teams_max %>% 
  ggplot(aes(sal_max)) + 
  geom_point(aes(y=Wprop)) + 
  geom_line(aes(y=pred),color="#3068A1") +
  labs(x = "Maximum player's salary in million US$ per team", y = "% Games won", 
       title = "Linear model of the maximum salary per team and % Games won")
div(ggplotly(salaries16_lm_max), align = "center")

#linear model for the maximum salary per team 
salaries16_teams_sum <- salaries16_teams_games %>% 
  subset(select = -c(sal_min, sal_max, sal_median, sal_mean, G, W, L)) %>%
  add_predictions(salaries16_teams_sum_lm) %>% add_residuals(salaries16_teams_sum_lm)

salaries16_lm_sum <- salaries16_teams_sum %>% 
  ggplot(aes(sal_sum)) + 
  geom_point(aes(y=Wprop)) + 
  geom_line(aes(y=pred),color="#3068A1") +  
  labs(x = "Spent money on players in million US$ per team", y = "% Games won", 
       title = "Linear model of the spent money on players per team and % Games won")
div(ggplotly(salaries16_lm_sum), align = "center")

stargazer(salaries16_teams_med_lm, salaries16_teams_max_lm, salaries16_teams_sum_lm, type = "HTML")
```

#Of Handedness and Baseball
The third chapter deals with the number of left-, right- and both handed baseball players, especially when batting and throwing. After data processing, the development of the handedness is analyzed and also compared to the average people's handedness.  

##Data for Proportions of Batting and throwing hands since 1871  

Our aim was to compute and plot the number of left, right and - if applicable - both-handed players that were in the league in any given year. The ```People``` table from Lahman's Baseball database contains information on each player's preferred batting and throwing hand, while the ```Appearances``` table contains information on which players were active each year, since 1871. Thus, if a player was active in, say 1871, he should appear in the ```Appearances``` table and given the information on his preferred batting and throwing hand from the ```People``` table, we should be able to derive the number of right, left, or both-handed players that were active in a given year. 

Unfortunately, a simple join of the ```People```and ```Appearances``` tables via the intended key "playerID" is not possible, since a given player can be listed multiple times in the ```Appearances``` table. This is usually due to players switching teams midseason. If a player switched teams, he will appear as many times in the ```Appearances``` table as the number of teams he played for that year. It follows that if we joined ```Appearances```and ```People``` and computed the number/proportion of players in each handedness category and year, we would count some players more than once. 

```{r}
#Check number of observations per player and year
Appearances %>% 
  count(playerID, yearID) %>% 
  filter(n > 1)
```  
We solved this issue by creating a new table ```didAppear``` which indicates whether a player appeared at least once in a given year (i.e., there's only one row per year and player).

```{r}
didAppear <- 
  Appearances %>% 
  group_by(yearID) %>% 
  distinct(playerID) %>% 
  ungroup()

didAppear
```

Now, each player is counted only once per active year. 
```{r}
didAppear %>% 
  count(playerID, yearID) %>% 
  filter(n > 1)
```  
The ```People``` table already has a unique key in "playerID".

```{r}
People %>% 
  count(playerID) %>% 
  filter(n > 1)
```


We used ```left_join()``` to combine the ```didAppear``` and the ```People``` tables. The variable "playerID" served as a key. In the resulting table ```players``` each row corresponds to a unique year-by-player combination. A players preferred batting hand is encoded in the variable "bats", while his preferred throwing hand is encoded in the variable "throws". We changed these variables from type "character" to type "factor" and ordered their possible outcomes as follows: Right < Left < Both for "bats", and Right < Left, for "throws" (Note that bats had 3 possible outcomes, while throws only had 2). This ordering ensured that the legends in the final plots were ordered from most frequent to least frequent. 

Unfortunately, the "throws" variable contained a single observation with the value "S" (instead of "R", or "L"). Since there was no mentioning of outcome "S" in the description of Lahman's baseball database, we concluded that this must be a typo or some other mistake. Therefore "S" was changed to "NA". 

```{r}
unique(People$throws) #possible outcomes for throws
sum(People$throws == "S", na.rm = T) #Count number of observations with "S"
People$throws[People$throws=="S"] <- NA
``` 


```{r}
players <- left_join(didAppear,People,by="playerID") %>% 
  mutate(
    bats = factor(bats, 
                  levels = c("R","L","B"),
                  labels= c("Right","Left","Both"), #3 possible outcomes
                  ordered=T),#To get the legend of the plot in the right order
    throws = factor(throws,
                    levels = c("R","L"),
                    labels = c("Right", "Left"), #only 2 possible outcomes
                    ordered = T)#To get the legend of the plot in the right order
  ) %>% 
  rename("year" = yearID)

#check if each playerID-by-year combination is unique
players %>% 
  count(playerID, year) %>% 
  filter(n > 1)
```

##Batting Hand
The table ```plrBats```contains each year's total number of observations for all three handedness categories (left, right, both; "observed"), the total number of observations, irrespective of handedness category ("N"), as well as the proportion of each handedness category ("proportion"). 
```{r}
plrBats <- players %>% 
  group_by(year,bats) %>% #Ensures that we get the data for each year
  count() %>%
  ungroup() %>% 
  drop_na() %>% #Drop observations for which the batting hand was not available
  group_by(year) %>% 
  mutate(
    "N" = sum(n), #Get total number of observations for each year (irrespective of handedness category) 
    "proportion" = round(n/sum(n),3)
  ) %>% 
  rename("observed" = n)
plrBats
```

###Plot  
We figured that the number of observations a given year's proportional estimate is based upon may be an important piece of information. In order to include this information, we used ```ggplotly()``` as it allowed us to include N in ```plotly```'s own "hover text". 
In more detail, we first created the ```ggplot```object ```batsPlot```  using ```geom_lines```to connect each year's proportions, with separate lines for each handedness category. Notice that we specified a third aesthetic "label = N" in addition to the x- and y-coordinates. This third aesthetic was necessary, as the ```tooltip```argument from ```ggplotly()``` can only display data that are specified as aesthetic arguments in the ```ggplot```object. 
If you hover your cursor over any data point in the plot, a text element should pop up, displaying the year, the proportion and the total number of observations, N. To specify which aesthetics are displayed by ```ggplotly```, we provided the  ```tooltip``` argument with a string vector of the follwoing aesthetics: "year", "proportion", "N". 


```{r}
batPlot <- 
  #aesthetic "label" is necessary for ggplotly's tooltip argument
  ggplot(plrBats, aes(year, proportion, label = N))+ 
  geom_line(aes(color=bats))+
  scale_x_continuous(name="Year", breaks = seq(1871,2018,20))+
  scale_y_continuous(breaks=seq(0,1,0.1))+
  scale_color_manual(values=c("#446A8B", "#555822", "#985C59"))+
  ylab("Proportion of Preferred Batting Hand")+
  labs(color="Batting \n Hand")+
  ggtitle("Proportional Distribution of Batting Hands")

#Convert ggplot object into plotly object
ggplotly(batPlot, tooltip = c("proportion", "year", "N")) 

```

##Throwing Hand  

To obtain the proportions of left- and right-handed throwers for each year, we proceeded analogously to the more detailed account above. The table ```plrThrows``` contains the each year's total number of observations both handedness categories (left and right; "observed"), the total number of observations, irrespective of handedness category ("N"), as well as the proportion of each handedness category ("proportion"). 

```{r}
plrThrows <- players %>% 
  group_by(year,throws) %>% 
  count() %>%
  ungroup() %>% 
  drop_na() %>% 
  group_by(year) %>% 
  mutate(
    "N" = sum(n),
    "proportion" = round(n/sum(n),3)) 

```

###Plot  
Again, ```ggplotly()``` was used to add the number of total observations a given years proportional estimate is based upon as a text element.   

```{r}
throwPlot <- 
  ggplot(plrThrows, aes(year, proportion, label = N))+
  geom_line(aes(color=throws))+
  scale_x_continuous(name="Year", breaks = seq(1871,2018,20))+
  scale_y_continuous(breaks=seq(0,1,0.1))+
  scale_color_manual(values=c("#446A8B", "#555822", "#985C59"))+
  ylab("Proportion of Preferred Throwing Hand")+
  labs(color="Throwing \n Hand")+
  ggtitle("Proportional Distribution of Throwing Hands")

ggplotly(throwPlot,tooltip = c("proportion", "year", "N"))
```  

##Linear Model 
...

#Of Age, Salaries and Handedness
The last chapter looks at all the factors described above, and figures out the relation between age, salary and handedness and the baseball-player's success. The sucess of a baseball player is measured by the Wins Above Replacement (WAR). 

##Linear Model