---
title: "Baseball yay"
subtitle: "Programming in Statistics - Project"
author: "Vilsmeier Johannes, Sterneder Florian, Schaub Andrea"
date: '`r Sys.Date()`'
output:
  html_document:
    code_folding: hide
    theme: cosmo
    highlight: tango
    number_sections: true
    toc: true
    toc_float: yes
    fig_width: 7
    fig_height: 4.5
---

```{r hide=T, warning=F, message=F}
library(knitr)
opts_chunk$set(echo = TRUE,
               collapse = TRUE,
               comment = "",
               strip.white = TRUE,
               warning = FALSE,
               messages = FALSE,
               out.width = "70%",
               fig.align = "center")
source("help.R")
```  
#Proportions of Batting And Throwing Hands Since 1871  

##Data Preparation   

Our aim was to compute and plot the number of left, right and - if applicable - both-handed players that were in the league in any given year. The ```People``` table from Lahman's Baseball database contains information on each player's preferred batting and throwing hand, while the ```Appearances``` table contains information on which players were active each year, since 1871. Thus, if a player was active in, say 1871, he should appear in the ```Appearances``` table and given the information on his preferred batting and throwing hand from the ```People``` table, we should be able to derive the number of right, left, or both-handed players that were active in a given year. 

Unfortunately, a simple join of the ```People```and ```Appearances``` tables via the intended key "playerID" is not possible, since a given player can be listed multiple times in the ```Appearances``` table. This is usually due to players switching teams midseason. If a player switched teams, he will appear as many times in the ```Appearances``` table as the number of teams he played for that year. It follows that if we joined ```Appearances```and ```People``` and computed the number/proportion of players in each handedness category and year, we would count some players more than once. 

```{r}
#Check number of observations per player and year
Appearances %>% 
  count(playerID, yearID) %>% 
  filter(n > 1)
```  
We solved this issue by creating a new table ```didAppear``` which indicates whether a player appeared at least once in a given year (i.e., there's only one row per year and player).

```{r}
didAppear <- 
  Appearances %>% 
  group_by(yearID) %>% 
  distinct(playerID) %>% 
  ungroup()

didAppear
```

Now, each player is counted only once per active year. 
```{r}
didAppear %>% 
  count(playerID, yearID) %>% 
  filter(n > 1)
```  
The ```People``` table already has a unique key in "playerID".

```{r}
People %>% 
  count(playerID) %>% 
  filter(n > 1)
```


# Of Age and Baseball

Let's anwers the simplest question first.

## How old is the average active professional baseball player?

```{r}
age_calc <- function(from,to=now()) floor(difftime(to, from)/dyears(1))
age_year = 2016
age_const = paste0(age_year,"0403")

age_c_players <- 
    left_join(Appearances %>% filter(yearID == age_year), People, "playerID") %>%
    mutate(birthDate = as_date(ymd(paste(birthYear, birthMonth, birthDay, sep = "-")))) %>%
    mutate(age = age_calc(birthDate, ymd(age_const))) %>%
    select(playerID, teamID, birthDate, age, nameFirst, nameLast, G_all, GS) 
```

We define active as in "played this season" which in our case and dataset is the season of `r age_year`. Also we calculate the age with the start of the season (April 3rd).

We find that the average active professional baseball player , in the season of `r age_year`, was born `r mean(age_c_players$birthDate)` and was therefore `r age_calc(mean(age_c_players$birthDate),ymd(age_const))` years old. 

Let's visualize that.

```{r}
age_c_players %>% 
    ggplot(aes(x = age)) +
    geom_line(stat = "density") + 
    geom_vline(aes(xintercept = mean(age)), alpha = 0.5, color = "red")
```

Funfact: As we might be able to tell from the graph, the oldest player in the season of `r age_year` was `r age_calc(min(age_c_players$birthDate),ymd(age_const))`.

Now we know about the average active player. Let's go further.

## Does the age distribution differ significantly per team?

```{r}
names(color$team_main) <- sort(unique(age_c_players$teamID))

age_c_team <- age_c_players %>% 
   group_by(teamID) %>%
   summarise(meanAge = mean(age), medianAge = median(age)) %>%
   left_join(Teams %>% filter(yearID == age_year) %>% select(teamID,name,W,L,G), by = "teamID")
 
age_c_team %>% 
    ggplot(aes(reorder(teamID,meanAge), meanAge, color = teamID)) +
    geom_point(size = 2) + 
    scale_color_manual(values = color$team_main) +
    guides(color = FALSE) + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) 
```
So now we know that the the team with the - on average - youngest players are the `r (age_c_team %>% filter(meanAge == min(meanAge)))$name` while the `r (age_c_team %>% filter(meanAge == max(meanAge)))$name` deploys -again, on average- the oldest players. But the difference between these 'extremes' is `r signif(max(age_c_team$meanAge) - min(age_c_team$meanAge),3)` and in my view not that siginificant. 

We still want to know more, let's look at the related boxplot.

```{r}
age_c_players %>% 
    left_join(age_c_team, by = "teamID") %>%
    ggplot(aes(reorder(teamID,meanAge),age,color = teamID)) +
    geom_boxplot(notch = TRUE) +
    scale_color_manual(values = color$team_main) +
    guides(color=FALSE) + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) 
```
As we see, the IQR and Median isn't _that_ different between the teams. Maybe we can work out larger differences in the next question.

## What happens to the average team age if we weight the games that each player played?

The idea is to weight the playing time of each player and therefore see if teams rather put their faith in younger players or rather value experience. The formula we use to weigh each time is $$ \text{age}_p \frac{\text{games played}_p}{\frac{1}{n}\sum^n_{i=1}\text{games played}_i} $$

```{r}
age_c_team <- 
   left_join(
             age_c_players,
             (Teams %>% filter(yearID == age_year) %>% select(teamID,G, W, L)),
             "teamID"
            ) %>%
   group_by(teamID) %>% 
   add_count() %>%
   mutate(G_avg = mean(G_all),GS_avg = mean(GS)) %>%
   mutate(gProp = age*(G_all/G_avg), gsProp = age*(GS/GS_avg)) %>%
   summarise(weightByG = mean(gProp), weightByGS = mean(gsProp)) %>%
   left_join(age_c_team, "teamID")

#kable(sample_n(age_c_team,5), format="markdown")

age_c_team %>% 
    ggplot(aes(reorder(teamID, meanAge), weightByG, color = teamID)) +
    geom_point(aes(reorder(teamID, meanAge), meanAge, color = teamID), size = 0.8) +
    geom_point(size = 2) + 
    scale_color_manual(values = color$team_main) +
    geom_segment(aes(xend = teamID, yend = meanAge)) +
    guides(color = FALSE) + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) 
```

As we can can see, there are some differences if we weight the playing time, but most noticeable to me is that the shift is clearly toward more experienced players. To be exact, according to this new metric the average team is now `r signif(age_c_team %>% summarise(mean(weightByG-meanAge)),4)` years older which adds up to `r signif(age_c_team %>% summarise(sum(weightByG-meanAge)),4)` years in total for the whole league.

## Linear Model - performance and average team age

```{r}
age_c_team <- age_c_team %>% mutate(Wprop = W/G)
age_perf_mod <- lm(data=age_c_team, formula= Wprop ~ weightByG)
age_c_team <- age_c_team %>% add_predictions(age_perf_mod) %>% add_residuals(age_perf_mod)

age_c_team %>% ggplot(aes(weightByG)) + geom_point(aes(y=Wprop)) + geom_line(aes(y=pred),color="red")

age_c_team %>% ggplot(aes(resid)) + geom_freqpoly(binwidth=0.04)

age_c_team %>% ggplot(aes(weightByG, resid)) + geom_point()
```

```{r results="asis"}
stargazer(age_perf_mod, align=T, type='html')
```

## performance of individuals as they age

We used ```left_join()``` to combine the ```didAppear``` and the ```People``` tables. The variable "playerID" served as a key. In the resulting table ```players``` each row corresponds to a unique year-by-player combination. A players preferred batting hand is encoded in the variable "bats", while his preferred throwing hand is encoded in the variable "throws". We changed these variables from type "character" to type "factor" and ordered their possible outcomes as follows: Right < Left < Both for "bats", and Right < Left, for "throws" (Note that bats had 3 possible outcomes, while throws only had 2). This ordering ensured that the legends in the final plots were ordered from most frequent to least frequent. 

Unfortunately, the "throws" variable contained a single observation with the value "S" (instead of "R", or "L"). Since there was no mentioning of outcome "S" in the description of Lahman's baseball database, we concluded that this must be a typo or some other mistake. Therefore "S" was changed to "NA". 

```{r}
unique(People$throws) #possible outcomes for throws
sum(People$throws == "S", na.rm = T) #Count number of observations with "S"
People$throws[People$throws=="S"] <- NA
``` 


```{r}
players <- left_join(didAppear,People,by="playerID") %>% 
  mutate(
    bats = factor(bats, 
                  levels = c("R","L","B"),
                  labels= c("Right","Left","Both"), #3 possible outcomes
                  ordered=T),#To get the legend of the plot in the right order
    throws = factor(throws,
                    levels = c("R","L"),
                    labels = c("Right", "Left"), #only 2 possible outcomes
                    ordered = T)#To get the legend of the plot in the right order
  ) %>% 
  rename("year" = yearID)

#check if each playerID-by-year combination is unique
players %>% 
  count(playerID, year) %>% 
  filter(n > 1)
```

##Batting Hand
The table ```plrBats```contains each year's total number of observations for all three handedness categories (left, right, both; "observed"), the total number of observations, irrespective of handedness category ("N"), as well as the proportion of each handedness category ("proportion"). 
```{r}
plrBats <- players %>% 
  group_by(year,bats) %>% #Ensures that we get the data for each year
  count() %>%
  ungroup() %>% 
  drop_na() %>% #Drop observations for which the batting hand was not available
  group_by(year) %>% 
  mutate(
    "N" = sum(n), #Get total number of observations for each year (irrespective of handedness category) 
    "proportion" = round(n/sum(n),3)
  ) %>% 
  rename("observed" = n)
plrBats
```

##Plot  
We figured that the number of observations a given year's proportional estimate is based upon may be an important piece of information. In order to include this information, we used ```ggplotly()``` as it allowed us to include N in ```plotly```'s own "hover text". 
In more detail, we first created the ```ggplot```object ```batsPlot```  using ```geom_lines```to connect each year's proportions, with separate lines for each handedness category. Notice that we specified a third aesthetic "label = N" in addition to the x- and y-coordinates. This third aesthetic was necessary, as the ```tooltip```argument from ```ggplotly()``` can only display data that are specified as aesthetic arguments in the ```ggplot```object. 
If you hover your cursor over any data point in the plot, a text element should pop up, displaying the year, the proportion and the total number of observations, N. To specify which aesthetics are displayed by ```ggplotly```, we provided the  ```tooltip``` argument with a string vector of the follwoing aesthetics: "year", "proportion", "N". 


```{r}
batPlot <- 
  #aesthetic "label" is necessary for ggplotly's tooltip argument
  ggplot(plrBats, aes(year, proportion, label = N))+ 
  geom_line(aes(color=bats))+
  scale_x_continuous(name="Year", breaks = seq(1871,2018,20))+
  scale_y_continuous(breaks=seq(0,1,0.1))+
  scale_color_brewer(palette="Set1")+
  ylab("Proportion of Preferred Batting Hand")+
  labs(color="Batting \n Hand")+
  ggtitle("Proportional Distribution of Batting Hands")

#Convert ggplot object into plotly object
ggplotly(batPlot, tooltip = c("proportion", "year", "N")) 

```

##Throwing Hand  

To obtain the proportions of left- and right-handed throwers for each year, we proceeded analogously to the more detailed account above. The table ```plrThrows``` contains the each year's total number of observations both handedness categories (left and right; "observed"), the total number of observations, irrespective of handedness category ("N"), as well as the proportion of each handedness category ("proportion"). 

```{r}
plrThrows <- players %>% 
  group_by(year,throws) %>% 
  count() %>%
  ungroup() %>% 
  drop_na() %>% 
  group_by(year) %>% 
  mutate(
    "N" = sum(n),
    "proportion" = round(n/sum(n),3)
  ) 

```

##Plot  
Again, ```ggplotly()``` was used to add the number of total observations a given years proportional estimate is based upon as a text element.   

```{r}
throwPlot <- 
  ggplot(plrThrows, aes(year, proportion, label = N))+
  geom_line(aes(color=throws))+
  scale_x_continuous(name="Year", breaks = seq(1871,2018,20))+
  scale_y_continuous(breaks=seq(0,1,0.1))+
  scale_color_brewer(palette="Set1")+
  ylab("Proportion of Preferred Throwing Hand")+
  labs(color="Throwing \n Hand")+
  ggtitle("Proportional Distribution of Throwing Hands")

ggplotly(throwPlot,tooltip = c("proportion", "year", "N"))
```  

