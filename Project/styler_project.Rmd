---
title: "Baseball â€“ Of Handedness, Age and Salaries"
author: "Vilsmeier Johannes, Sterneder Florian, Schaub Andrea"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    css: ../rstyle.css
    highlight: tango
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_float: yes
subtitle: Programming in Statistics - Project
---
Creative Commons Attribution-ShareAlike 3.0 Unported License
```{r hide=T, warning=F, message=F}
source("help.R")
opts_chunk$set(echo = TRUE,
               collapse = TRUE,
               comment = "",
               strip.white = TRUE,
               warning = FALSE,
               messages = FALSE,
               tidy = "styler",
               tidy = FALSE,
               fig.align = "center")
theme_set(theme_light())
options(warn=-1)
```  

##Introduction   

Sean Lahman's Baseball Database ( [Link](http://www.seanlahman.com/baseball-archive/statistics/)) consists of over 30 data tables on pitching, hitting, and fielding statistics for Major League Baseball (MLB) from 1871 through 2018 (for supposedly every player that ever played, as well as every team that ever existed). In this project, we will focus on three aspects of baseball: the players' handedness, age and salaries. We will use the following data tables: 
  
  * `Appearances`: Contains information on the number of games players appeared in, the teams they played for, as well as how many games they played at each position, for every season, since 1871.
  
  * `People`: All baseball players since 1871, with demographic data like birth date, first game, last game, handedness.
  
  * `Teams`: Contains information on teams, and how they faired each season (number of wins, number of losses, games played, etc.). 
  
  * `Salaries`: Per player and team, years 1985-2016
  
We use *Wins Above Replacement* (WAR), an often used "sabermetric" that quantifies how valuable a given player is to his team's success, as an outcome variable for our linear models. WAR represents the number of a team's additional wins that are due to the player as compared to the number of wins expected, if the player were replaced by a hypothetical average player. The computation of WAR is quite complex, and, depending on whether we're dealing with a position player or a pitcher, WAR is computed differently. Luckily, baseball-reference.com provides WAR statistics for (supposedly) every baseball player in the history of baseball, taking into account a player's position (i.e., there are two data tables: One for position players and one for pitchers; [Link](https://www.baseball-reference.com/about/war_explained.shtml)).  
We downloaded Baseball Reference's "WAR for Position Players" (`warPos`) and "WAR for Pitchers" (`warPit`) tables and merged these with the data tables from Lahman's baseball data bank, mentioned above.   

From other databases we use: 
  
  * `Salaries_US` (from [OECD](https://data.oecd.org/earnwage/average-wages.htm#indicator-chart)): Average US-wages from 1990-2017. Unfortunately, more accurate data for the wages than the average was not found. Be careful with interpreting the data, as with wages, the mean and the median differ a lot. 
  
  
Most of our linear models focus on the year 2016 (although some analyses are wider). This year was chosen because it shows the latest data available on all three main aspects: Handedness, age and salaries. 
  
There are four different sections, which will walk you through the baseball (2016) analysis: 
  

Section 1 is concerened with handedness. More specifically, we ask whether the distribution of right-, left- and both-handed players has changed since the first season in 1871, and whether a player's expected WAR differs as a function of handedness (i.e., are there group differences?). 

In Section 2, we look at the distribution of age and how a team's average age could be connected to its success (measured by wins). We also look at the relationship between player age and expected WAR.  

Section 3 is all about player salaries. How did player salaries change over years and are there any differences between leagues? How do baseball players' salaries compare to the average US income? Also, the highest amounts of money spent by teams and the most earning players are analyzed. Does spending a lot of money on a team lead to success? Do high earning players play better?

Finally, in section 4 we use handedness, age, and salary, to build a linear model for expected WAR, given these covariates. 

#Of Handedness  

##Proportions of Batting and Throwing Hands Since 1871 

Our aim is to compute and plot the proportions of left, right and - if applicable - both-handed players for each year. Thus, the relevant columns are "bats" and "throws" (both come from the `People` table). A player's preferred batting hand is encoded in the column "bats", while his preferred throwing hand is encoded in the column "throws". Note that "bats" has three possible outcomes ("L","R", and "B"), while "throws" only has two ("L" and "R").
Unfortunately, there's a single observation with value "S" (instead of "R", or "L") in the "throws" table. Since there is no mention of outcome "S" in the description of Lahman's baseball database (maybe we should notify Sean Lahman) "S" is changed to `NA`. 

```{r tidy=TRUE}
unique(People$throws) #possible outcomes for throws
sum(People$throws == "S", na.rm = T) #Count number of observations with "S"
People$throws[People$throws=="S"] <- NA
```  

To further analyze our data, we need to create a new table, `did_appear`, which has only one row for each player-by-year combination (`Appearances` has multiple observations per player and year, due to players switching teams midseason).


```{r tidy=TRUE}
did_appear <- 
  Appearances %>% 
  group_by(yearID) %>% 
  distinct(playerID) %>% 
  ungroup()
did_appear
```

We then joined `did_appear` and `People` to obtain the data frame `players`. Each row in this new data frame corresponds to a unique player-by-year-by-bats-by-throws combination. Thus, we are now able to compute the number of right-, left- (or both-)handed players per season.

```{r tidy=TRUE}
players <- left_join(did_appear, People,by="playerID") %>% 
  mutate(
    bats = factor(bats, 
                  levels = c("R","L","B"),
                  labels= c("Right","Left","Both"), #3 possible outcomes
                  ordered=F),
    throws = factor(throws,
                    levels = c("R","L", NA),
                    labels = c("Right", "Left"), #only 2 possible outcomes
                    ordered = F)
  ) 
#check if each playerID-by-year combination is unique
# players %>% 
#   count(playerID, yearID) %>% 
#   filter(n > 1)
```

###Batting Hand 
The table `plr_bats`contains each year's total number of observations across all three batting-hand categories (left, right, both; "observed"), the total number of observations irrespective of handedness category ("N"), as well as the proportion of each handedness category ("proportion"). 
```{r tidy=TRUE}
plr_bats <- players %>% 
  group_by(yearID,bats) %>% #Ensures that we get the data for each year
  count() %>%
  ungroup() %>% 
  drop_na() %>% #Drop observations for which the batting hand was not available
  group_by(yearID) %>% 
  mutate(
    "N" = sum(n), #Get total number of observations for each year (irrespective of handedness category) 
    "proportion" = round(n/sum(n),3)
  ) %>% 
  rename("observed" = n)
plr_bats
```


```{r tidy=TRUE}
(bat_plot <-
  ggplot(plr_bats, aes(yearID, proportion #, label = N
                       ))+ 
  geom_line(aes(color=bats))+
  scale_x_continuous(name="Year", breaks = seq(1871,2018,20))+
  scale_y_continuous(breaks=seq(0,1,0.1))+
  scale_color_manual(values=c("#446A8B", "#555822", "#985C59"))+
  ylab("Proportion of Preferred Batting Hand")+
  labs(color="Batting \n Hand")+
  ggtitle("Proportional Distribution of Batting Hands"))

#Convert ggplot object into plotly object
#div(ggplotly(bat_plot, tooltip = c("proportion", "yearID", "N")),align="center") 
``` 
The plot might make us think that the proportion of right-handed batters first increased steeply between 1871 and 1876 (up to .88, while in the same time span, the proportion of left- and both-handed batters decreased in a similar fashion) and then decreased again until settling somewhere between 0.6 and 0.7 from 1900 onwards. However, this early rise and fall in the proportion of right handed batters does not necessarily represent a genuine trend but may simply reflect the degree of uncertainty in the proportions that come with relatively small sample sizes, especially in the early years (Also, there are many ``NA``s). For instance, the proportions for 1871 are based on a total of $N = 48$ observations and if we take a look at the actual number of observations within each handedness group we will notice that there was only **one** both-handed batter in our data frame in 1871.

###Throwing Hand 
The table `plr_throws` contains each year's total number of observations for the two handedness categories, left and right ("observed"), the total number of observations, irrespective of handedness category ("N"), as well as the proportion of each handedness category ("proportion"). 

```{r tidy=TRUE}
plr_throws <- players %>% 
  group_by(yearID,throws) %>% 
  count() %>%
  ungroup() %>% 
  drop_na() %>% 
  group_by(yearID) %>% 
  mutate(
    "N" = sum(n),
    "proportion" = round(n/sum(n),3)
  ) %>% 
  rename("observed" = n)
plr_throws

```


```{r tidy=TRUE}
(throw_plot <- 
   ggplot(plr_throws, aes(yearID, proportion #, label = N
   ))+
   geom_line(aes(color=throws))+
   scale_x_continuous(name="Year", breaks = seq(1871,2018,20))+
   scale_y_continuous(breaks=seq(0,1,0.1))+
   scale_color_manual(values=c("#446A8B", "#555822", "#985C59"))+
   ylab("Proportion of Preferred Throwing Hand")+
   labs(color="Throwing \n Hand")+
   ggtitle("Proportional Distribution of Throwing Hands"))


#Convert ggplot object into plotly object
#div(ggplotly(throw_plot, tooltip = c("proportion", "yearID", "N")),align="center") 
```    
It seems as if the proportion of right handed throwers decreased over time (while the proportion of left handed throwers increased), yet, a more thorough inspection of the single data points reveals that the early proportional estimates are based on relatively small sample sizes, as compared to later years.

###Handedness and WAR for Position Players  
We now compare position players' WAR statistics as a function of batting and throwing hand. 

```{r tidy=TRUE}
#Select subset of position players that played in 2016
war_pos_16 <- warPos %>% 
  filter(year_ID==2016)
#Select subset of players that played in 2016
appearances_2016 <- Appearances %>% 
  filter(yearID == 2016)  
```

First, we identify players who played for more than one team in 2016. These players will show up as multiple observations (i.e., multiple rows) in the `war_pos_16` data table, that is, some players will contribute more than one WAR statistic.  
```{r tidy=TRUE}
#Show players that played for multiple teams in 2016
war_pos_16 %>% 
  count(player_ID) %>% 
  arrange(desc(n)) %>% 
  filter(n>1)
```  
Now that we can be assured that ```war_pos_2016``` contains more than one WAR for 124 different players, we will have to figure out a way to deal with this later on. 

But first, we continue merging our data frames, until we have each players preferred batting and throwin hand as well as their WAR statistic(s) in a single data frame, namely `pos_2016` ("pos" for "position players").

```{r tidy=TRUE}
#Get the bbrefID column
players_2016 <- players %>% 
  filter(yearID==2016)

# #Check if bbrefID is key
# players_2016 %>% 
#   count(bbrefID) %>% 
#   filter(n > 1)

pos_2016 <- appearances_2016 %>% 
  left_join(players_2016, by="playerID") #retain lost information from earlier

```


```{r tidy=TRUE}
# # We checked whether the combination of "bbrefID" and "teamID" served as a key.
# pos_2016 %>% 
#   count(bbrefID,teamID) %>% 
#   filter(n>1)
```

```{r tidy=TRUE}
#Combine appearances_2016 and war_pos_16 tables
pos_2016 <- pos_2016 %>% 
  left_join(war_pos_16, by = 
              c(c("bbrefID" = "player_ID"), c("teamID"="team_ID"))) %>% 
  select(playerID, teamID, G_all, WAR, bats, throws)

# #Check if playerID and teamID are unique keys
# pos_2016 %>% 
#   count(playerID, teamID) %>% 
#   filter(n>1)
```
To deal with the problem of multiple observations per player, we decided to weigh each player's WAR(s) by the proportion of total games he played for each team and take the sum (i.e., a weighted mean WAR):  

$$
\text{weightedWAR}_i = \sum_{k=1}^{m}\frac{i\text{'s number of games played for team }k }{i\text{'s total number of games played}}\times WAR_{ik} ,
$$  
where $i$ refers to the $i$th player, and $k$ to the $k$th team he played for in 2016. Note that if a player's WAR for a given team was coded as `NA`, the player's stint with that team was simply ignored in the computation.  

The function `wghtWAR()` (see help.R file) implements the above equation. In order to apply `wghtWAR()` to each player, we need to nest WAR within players. The resulting variable, "weightedWAR", will be used as a response variable for our linear models.  

```{r tidy=TRUE, warning=F}
#Nest number of WAR-osbervations by players
pos_2016 <- nest(pos_2016, c(G_all,teamID), key = "WAR")
#Compute weighted WAR for each player
pos_2016 <- pos_2016 %>% 
  mutate(
  "weightedWAR" = lapply(pos_2016$data, function(x) wghtWAR(x)) %>% unlist
)   
```

We then plotted "weightedWAR" as a function of batting hand.
```{r tidy=TRUE}
#raw data for batting hand
pos_2016 %>% 
  drop_na() %>% 
  ggplot()+
  geom_jitter(aes(bats,weightedWAR),alpha=.5,
              position=position_jitter(width=.2))+
  xlab("Batting Hand")+
  ylab("Weighted Average WAR")+
  ggtitle("Position Players: WAR by Batting Hand")
```
The scatter plot indicates that for position players, on average, right-, left- and both-handed batters do not differ with respect to WAR.  

Let's build a linear model to obtain a closer look. Right-handed batters are chosen as the reference category. The equation for the expected weighted WAR for the $i$th player:  
$$
\widehat{\text{weighted WAR}}_i = \widehat{\beta}_0+\widehat{\beta}_1 Left_i+\widehat{\beta}_2 Both_i.
$$

```{r tidy=TRUE}
model_bats_pos <- lm(weightedWAR~bats, data = pos_2016)
```

```{r tidy=TRUE, results = "asis"}
stargazer(model_bats_pos, type = "html", align = T)
```
<br>

The scatter plot for throwing hand:
```{r tidy=TRUE}
#raw data for throwing hand
pos_2016 %>% 
  drop_na() %>% 
  ggplot()+
  geom_jitter(aes(throws,weightedWAR),alpha=.5,
              position=position_jitter(width=.2)) +
  xlab("Throwing Hand")+
  ylab("Weighted Average WAR")+
  ggtitle("Position Players: WAR by Throwing Hand")
```
The expected weighted WARs of right and left handed throwers do not seem to differ for position players. 

The linear model:
$$
\widehat{y}_i = \widehat{\beta}_0+\widehat{\beta}_1 Left_i
$$  
```{r tidy=TRUE}
model_throws_pos <- lm(weightedWAR~throws, data = pos_2016)
```

```{r tidy=TRUE, results = "asis"}
stargazer(model_throws_pos, align = T, type = "html")
```


###Handedness and WAR for Pitchers  

For pitchers, we proceed analogous to the analysis of position players. 
```{r  tidy=TRUE}
# #Select subset of pitchers who played in 2016
war_pit_16 <- warPit %>% 
  filter(year_ID==2016)


# #Check if player_ID, team_ID ist key
# war_pit_16 %>% 
#   count(player_ID, team_ID) %>% 
#   filter(n>1)
#Add bbrefID column to pit2016
pit_2016 <- appearances_2016 %>% 
  left_join(players_2016, by="playerID")
#Combine appearances_2016 and warPit2016 tables
pit_2016 <- pit_2016 %>% 
  left_join(war_pit_16, by = 
              c(c("bbrefID" = "player_ID"), c("teamID"="team_ID"))) %>% 
  select(playerID, teamID, G_all, WAR, bats, throws)
```


Again, we nested "teams", "games played", and "WAR" within players and applied `wghtWAR()` to obtain a weighted average WAR for each player. 
```{r  tidy=TRUE}
#Nest number of WAR-osbervations by players
pit_2016 <- nest(pit_2016, -playerID, -bats, -throws)
#Compute weighted WAR for each player
pit_2016 <- pit_2016 %>% 
  mutate(
  "weightedWAR" = lapply(pit_2016$data, function(x) wghtWAR(x)) %>% unlist
)   
```

The scatterplot plot for WAR by batting hand:
```{r  tidy=TRUE}
#raw data for batting hand
pit_2016 %>%   
  drop_na() %>% 
  ggplot()+
  geom_jitter(aes(bats,weightedWAR),alpha=.5,
              position=position_jitter(width=.2))+
  xlab("Batting Hand")+
  ylab("Weighted Average WAR")+
  ggtitle("Pitchers: WAR by Batting Hand")
``` 
The plot does not indicate that there is any mean difference between left vs. right handed players or both vs. right handed players with respect to WAR. 

The linear model for batting hand:
```{r  tidy=TRUE}
model_bats_pit <- lm(weightedWAR~bats, data = pit_2016)
```

```{r tidy=TRUE, results = "asis"}
stargazer(model_bats_pit, align = T, type = "html")
``` 
<br><br>
The scatter plot for WAR by throwing hand:
```{r  tidy=TRUE}
#raw data for throwing hand
pit_2016 %>%   
  drop_na() %>% 
  ggplot()+
  geom_jitter(aes(throws,weightedWAR),alpha=.5,
              position=position_jitter(width=.2)) +
  xlab("Throwing Hand")+
  ylab("Weighted Average WAR")+
  ggtitle("Pitchers: WAR by Throwing Hand")
```
No mean group differences seem to be present.

The linear model for throwing hand: 
```{r  tidy=TRUE}
model_throws_pit <- lm(weightedWAR~throws, data = pit_2016)
```

```{r tidy=TRUE, results = "asis"}
stargazer(model_throws_pit, align = T, type = "html")
``` 

#Of Age
This chapter analyzes the age of baseball players, focusing on the season of 2016. First the average age is computed, then differences between the teams and their average players age are analyzed. At the end of this chapter, we will build a model which tries to answer the questions "How old is a good baseball player?" or "Do they get better with age?".

##Age of the average active baseball player in 2016

```{r  tidy=TRUE}
age_calc <- function(from,to=now()) difftime(to, from)/dyears(1)
age_current <- 2016
age_const <- function(year=2016) paste0(year,"0403")
age_c_players <- 
  left_join(Appearances %>% filter(yearID == age_current), People, "playerID") %>%
  mutate(birthDate = as_date(ymd(paste(birthYear, birthMonth, birthDay, sep = "-")))) %>%
  mutate(age = age_calc(birthDate, ymd(age_const(age_current)))) %>%
  select(playerID, teamID, birthDate, age, nameFirst, nameLast, G_all, GS)
```

We define active as in "played in season `r age_current`". That means if a player was in the roster of a team but didn't at least made on appearance, then he will not be considered in our following analysis. Also we calculate the age with the start of the season of 2016 (April 3rd).

We find that the average active professional baseball player , in the season of `r age_current`, was born `r mean(age_c_players$birthDate)` and was therefore `r floor(age_calc(mean(age_c_players$birthDate),ymd(age_const(age_current))))` years old. 

Let's visualize that.

```{r  tidy=TRUE}
age_plot <- age_c_players %>% 
  ggplot(aes(x = age)) +
  geom_line(stat="density") + 
  geom_vline(aes(xintercept = mean(age)), alpha = 0.5, color = "#3068A1") +
  labs(x = "Age", y = "Density", title = "Age Density")

div(ggplotly(age_plot), align = "center")
```

Funfact: As we might be able to tell from the graph, the oldest player in the season of `r age_current` was `r floor(age_calc(min(age_c_players$birthDate),ymd(age_const(age_current))))`.

Now we know more about the average active player in `r age_current`. Let's go further.

##Differences in the age distribution per team

```{r  tidy=TRUE}
names(color$team_main) <- sort(unique(age_c_players$teamID))

age_c_team <- age_c_players %>% 
  group_by(teamID) %>%
  summarise(meanAge = mean(age), medianAge = median(age)) %>%
  left_join(Teams %>% filter(yearID == age_current) %>% select(teamID,name,W,L,G), by = "teamID")
 
age_c_team %>% 
  ggplot(aes(reorder(teamID,meanAge), meanAge, color = teamID)) +
  geom_point(size = 2) + 
  scale_color_manual(values = color$team_main) +
  guides(color = FALSE) + labs(x = "Team", y = "Average Age", title = "Average Age by Team") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```
So now we know that the team with the - on average - youngest players are the `r (age_c_team %>% filter(meanAge == min(meanAge)))$name` while the `r (age_c_team %>% filter(meanAge == max(meanAge)))$name` deploys - again, on average - the oldest players. The difference between these 'extremes' is `r signif(max(age_c_team$meanAge) - min(age_c_team$meanAge),3)` years and is less than one might would have expected.

We still want to know more, let's look at the related box plot.

```{r  tidy=TRUE}
age_c_players %>% 
  left_join(age_c_team, by = "teamID") %>%
  ggplot(aes(reorder(teamID,meanAge),age,color = teamID)) +
  geom_boxplot(notch = TRUE) +
  scale_color_manual(values = color$team_main) +
  guides(color = FALSE) + labs(x = "Team", y = "Average Age", title = "Average Age by Team") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```
As we see, the IQR and Median isn't _that_ different between the teams. Maybe we can work out larger differences in the next question.

##Weighted average team age

The idea is to weight the playing time of each player and therefore see if teams rather put their faith in younger players or value experience. The formula we use to weigh each time is $$ \text{age}_p \frac{\text{games played}_p}{\frac{1}{n}\sum^n_{i=1}\text{games played}_i} $$

```{r  tidy=TRUE}
age_c_team <- 
  left_join(
           age_c_players,
           (Teams %>% filter(yearID == age_current) %>% select(teamID,G, W, L)),
           "teamID"
           ) %>%
  group_by(teamID) %>% 
  add_count() %>%
  mutate(G_avg = mean(G_all),GS_avg = mean(GS)) %>%
  mutate(gProp = age*(G_all/G_avg), gsProp = age*(GS/GS_avg)) %>%
  summarise(weightByG = mean(gProp), weightByGS = mean(gsProp)) %>%
  left_join(age_c_team, "teamID")
age_c_team %>% 
  ggplot(aes(reorder(teamID, meanAge), weightByG, color = teamID)) +
  geom_point(aes(reorder(teamID, meanAge), meanAge, color = teamID), size = 0.8) +
  geom_point(size = 2) + 
  scale_color_manual(values = color$team_main) +
  geom_segment(aes(xend = teamID, yend = meanAge)) +
  guides(color = FALSE) + 
  labs(y = "Age Weighted By Games Played", x = "Team", title = "Difference in Average Age after Weighting per Team") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) 
```

As we can can see, there are some differences if we weight the playing time, but most noticeable is that the shift is clearly toward more experienced players. To be exact, according to this new metric the average team is now `r signif(age_c_team %>% summarise(mean(weightByG-meanAge)),4)` years older which adds up to `r signif(age_c_team %>% summarise(sum(weightByG-meanAge)),4)` years in total for the whole league.

##Games Won and Average Team Age 

###Season 2016

With the information we got so far we build a linear model to see if there is a connection between the percentage of games won by a team and their weighted average age. The model looks like this:

$$ \widehat{\text{Wins%}}_i = \hat{\beta_0} + \hat{\beta_1} \text{weighted Average Age}_i $$

```{r  tidy=TRUE}
age_c_team <- age_c_team %>% mutate(Wprop = (W/G)*100)
age_team_perf_mod <- lm(Wprop ~ weightByG, data = age_c_team)
age_c_team <- age_c_team %>% add_predictions(age_team_perf_mod) %>% add_residuals(age_team_perf_mod)

age_c_team %>% 
  ggplot(aes(weightByG)) + 
  geom_point(aes(y=Wprop)) +
  geom_line(aes(y=pred),color="#3068A1") +
  labs(x = "Average Team Age Weighted By Games Played", y = "% Games won", title = "Linear Model Visualization")
```

```{r tidy=TRUE, results = "asis"}
stargazer(age_team_perf_mod, align=T, type='html', style="all2")
```
<br>
If we believed in this model, we could argue, since there is a positive slope, that it would be advantageous for a team to field older players. But although this model looks promising, it might suffer from a rather small sample size ($N=30$). In the next step we are going to expand our sample by looking at the data from the season 1985 to 2016.

###Season 1985 - 2016
```{r  tidy=TRUE}
age_from = 1985
age_f_players <- 
  left_join(Appearances %>% filter(yearID %in% seq(from = age_from, to = age_current)), People, "playerID") %>%
  mutate(birthDate = as_date(ymd(paste(birthYear, birthMonth, birthDay, sep = "-")))) %>%
  mutate(age = age_calc(birthDate, ymd(age_const(yearID)))) %>%
  select(yearID, playerID, teamID, birthDate, age, nameFirst, nameLast, G_all, GS) 

age_f_team <- age_f_players %>% 
  group_by(yearID, teamID) %>%
  summarise(meanAge = mean(age), medianAge = median(age)) %>%
  left_join(Teams %>% filter(yearID %in% seq(from= age_from, to = age_current)) %>% select(yearID, teamID,name,W,L,G), by = c("teamID","yearID"))

age_f_team <- 
  left_join(
           age_f_players,
           (Teams %>% filter(yearID %in% seq(from = age_from, to = age_current)) %>% select(teamID,G, W, L)),
           "teamID"
           ) %>%
  group_by(yearID, teamID) %>% 
  add_count() %>%
  mutate(G_avg = mean(G_all),GS_avg = mean(GS)) %>%
  mutate(gProp = age*(G_all/G_avg), gsProp = age*(GS/GS_avg)) %>%
  summarise(weightByG = mean(gProp), weightByGS = mean(gsProp)) %>%
  left_join(age_f_team, c("teamID","yearID")) %>%
  mutate(Wprop = (W/G)*100)
```

Now that we look at data from `r age_current - age_from` seasons we find that the difference between the team with the highest and the lowest average team age is now `r signif(max(age_f_team$meanAge) - min(age_f_team$meanAge),3)` years. We also find fun stuff, like the `r age_t <- (age_f_team %>% filter(L == max(age_f_team$L))); paste(age_t$yearID,age_t$name)` who lost `r age_t$L` games while the `r age_t <- (age_f_team %>% filter(G == min(age_f_team$G)))[1,] ; paste(age_t$yearID, age_t$name)` only played `r age_t$G`.

Let's have a look at our model.

```{r  tidy=TRUE}
age_team_perf_mod <- lm(Wprop ~ weightByG, data = age_f_team)
age_f_team <- age_f_team %>% add_predictions(age_team_perf_mod, var="ls") %>% add_residuals(age_team_perf_mod)

age_f_team %>% 
  ggplot(aes(weightByG)) + 
  geom_point(aes(y=Wprop)) +
  geom_line(aes(y=ls),color="#3068A1") +
  labs(x = "Average Team Age Weighted By Games Played", y = "% Games won", title = "Linear Model Visualization (least square)")
```

```{r tidy=TRUE, results = "asis"}
stargazer(age_team_perf_mod, align=T, type='html', style="all2")
```
<br>
We find that we can see a similar trend in the extended dataset, only the slope is a bit flatter. But now we can say with a bit more confidence that teams with a higher average team age win more games than teams with younger players over the course of a season. 

How would a local regression model look? Let's see.

```{r  tidy=TRUE}
age_team_perf_mod <- loess(Wprop ~ weightByG, data = age_f_team, degree = 1)
age_f_team <- age_f_team %>% add_predictions(age_team_perf_mod) %>% add_residuals(age_team_perf_mod)

age_f_team %>% 
  ggplot(aes(weightByG)) + 
  geom_point(aes(y=Wprop)) +
  geom_line(aes(y=pred),color="red") +
  geom_line(aes(y=ls),color="#3068A1") +
  labs(x = "Average Team Age Weighted By Games Played", y = "% Games won", title = "Linear Model Visualization (LOESS)")
```

With first degree polynomials still looks rather steady with a small bump in the middle of the data (around age 29).

A $R^2$ value of only 10% might not look too strong, it could still be argued that the model shows an interesting trend in the data. 

Now that we looked at teams, how about individual players? Can we find the same trend that more experienced players show better performance statistics?

##Player Age and Wins Above Replacement

As the performance indicator we again use Wins Above Replacement, which according to [FanGraphs](https://library.fangraphs.com/misc/war/) is _[...] all-inclusive and provides a useful reference point for comparing players._

```{r  tidy=TRUE}
age_war_pos <- left_join(age_c_players, pos_2016 %>%
  select(-bats,-throws,-data)) %>%
  group_by(playerID,birthDate,age,weightedWAR) %>% 
  summarise(G_all = sum(G_all), GS = sum(GS)) %>%
  ungroup()

age_war_pit <- left_join(age_c_players, pit_2016 %>%
  select(-bats,-throws,-data)) %>%
  group_by(playerID,birthDate,age,weightedWAR) %>% 
  summarise(G_all = sum(G_all), GS = sum(GS)) %>%
  ungroup()

```

In regards to missing values, in the WAR data for position players we miss `r dim(age_war_pos %>% filter(is.na(weightedWAR)))[1]` out of `r dim(age_war_pos)[1]`. And for pitchers we miss `r dim(age_war_pit %>% filter(is.na(weightedWAR)))[1]` out of `r dim(age_war_pit)[1]`.

```{r  tidy=TRUE}
age_war_pos <- age_war_pos %>% drop_na(weightedWAR)
```

Here is how our model looks:
$$ \widehat{\text{weightedWAR}}_i = \hat{\beta_0} + \hat{\beta_1} \text{Age}_i $$

```{r  tidy=TRUE}
age_war_pos_mod <- age_war_pos %>% lm(formula = weightedWAR ~ age)
age_war_pos <- age_war_pos %>% add_predictions(age_war_pos_mod) %>% add_residuals(age_war_pos_mod)

age_war_pos %>% 
  ggplot(aes(age)) + 
  geom_point(aes(y=weightedWAR)) +
  geom_line(aes(y=pred),color="#3068A1") + 
  labs(x = "Age", y = "weighted WAR", title = "Position: Age - weighted WAR")
```

```{r tidy=TRUE, results = "asis"}
stargazer(age_war_pos_mod, align=T, type='html')
```
<br>
There seems to be no connection between WAR for position players and age. How about pitchers?

```{r  tidy=TRUE}
age_war_pit_mod <- age_war_pit %>% lm(formula = weightedWAR ~ age) 
age_war_pit <- age_war_pit %>% add_predictions(age_war_pit_mod) %>% add_residuals(age_war_pit_mod)

age_war_pit %>% 
  ggplot(aes(age)) + 
  geom_point(aes(y=weightedWAR)) +
  geom_line(aes(y=pred),color="#3068A1") +
  labs(x = "Age", y = "weighted WAR", title = "Pitcher: Age - weighted WAR")

```

```{r tidy=TRUE, results = "asis"}
stargazer(age_war_pit_mod, align=T, type='html')
```
<br>
There seems to be no connection between these variables for pitchers either.

What if we combine the WAR for both position players and pitchers?

```{r  tidy=TRUE}
combo_2016 <- 
  left_join(pit_2016, pos_2016, c("playerID","bats","throws")) %>%
  mutate(weightedWAR.y = if_else(is.na(weightedWAR.y),0,weightedWAR.y)) %>%
  mutate(weightedWAR = weightedWAR.x + weightedWAR.y, data = data.x) %>%
  select(-data.x, -data.y, -weightedWAR.x, -weightedWAR.y)

age_war_combo <- left_join(age_c_players, combo_2016 %>%
  select(-bats,-throws,-data)) %>%
  group_by(playerID,birthDate,age,weightedWAR) %>% 
  summarise(G_all = sum(G_all), GS = sum(GS)) %>%
  ungroup()
```

```{r  tidy=TRUE}
age_war_combo_mod <- age_war_combo %>% lm(formula = weightedWAR ~ age)
age_war_combo <- age_war_combo %>% add_predictions(age_war_combo_mod) %>% add_residuals(age_war_combo_mod)

age_war_combo %>% 
  ggplot(aes(age)) + 
  geom_point(aes(y=weightedWAR)) +
  geom_line(aes(y=pred),color="#3068A1") +
  labs(x = "Age", y = "weighted WAR", title = "Combination: Age - weighted WAR")
```

```{r tidy=TRUE, results = "asis"}
stargazer(age_war_combo_mod, align=T, type='html')
```

No connection here either.

#Of Salaries
After looking at the average age of baseball players, we take a look at what they earn. Is it more/less depending on the league? How is the salary development compared to the average US-salary? After answering these questions, the mostpaying teams in 2016 and mostpaid players in the 2000s and 2016 are also listed. The main questions, if a team that spends much on their players, wins more, and if a good baseball player also gets paid high, are asked at the end. 

####Adjusting the statistics {-}
Before starting the analysis, we have to prepare our data. In both tables, we look at the (average) million US$ earned per year and calculate some other statistical values per year (if available).
```{r tidy=TRUE, salaries_adjust}
#Adjusting US-Salaries data

#renaming the columns
colnames(Salaries_US) = c("country", "indicator", "subject", "currency", "frequency", "yearID", "av_wage_US", "Flag_codes")
Salaries_US <- Salaries_US %>%
  #dropping columns
  #subset(select = -c(country, indicator, subject, frequency, Flag_codes)) %>%
  print()%>%
  mutate(
    #wages converted into million US$
    av_wage_US = av_wage_US/1000000,
    #calculating average development
    #  not needed: av_wage_perc = ((av_wage_US/lag(av_wage_US) - 1) * 100),
    av_wage_100perc = ((av_wage_US-min(av_wage_US))/max(av_wage_US))*100)
(Salaries_US)

#Adjusting Salaries (baseball) data
Salaries <- Salaries %>%
  #converting into million US$
  mutate(salary = salary/1000000)
(Salaries)
sal_bb_stats <- Salaries %>%
  group_by(yearID) %>%
  summarise(n_players = n(), 
            n_teams = n_distinct(teamID),
            n_dist_players = n_distinct(playerID),
            salary_mean = mean(salary),
            salary_max = max(salary),
            salary_min = min(salary),
            salary_median = quantile(salary, probs = 0.5))
sal_bb_stats
#for the US-salary comparison, years from 1990 on are filtered
sal_bb_stats_90 <- sal_bb_stats %>%
  filter(yearID >= 1990) %>%
  mutate(#  not needed: salary_mean_perc = ((salary_mean/lag(salary_mean) - 1) * 100),
         salary_mean_100perc = ((salary_mean-min(salary_mean))/max(salary_mean))*100) 
```
  
##Overview
To get to know the data, a boxplot is made. It shows the median salary, and the first and third quantile. 
```{r tidy=TRUE, salaries_statistics, cache = T}
summary(Salaries)
#boxplot with the player salaries
sal_boxplot <- ggplot() + 
  geom_boxplot(data = Salaries, aes(x = yearID, y = salary, group = cut_width(yearID, 1)), alpha = 0.5) + 
  geom_line(data = sal_bb_stats, aes(x = yearID, y = salary_mean), color = "#3068A1") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = Salaries$yearID) +
  labs(x = "Year", y = "Salary in million US$", 
       title = "Baseball-players' Salaries") 
(sal_boxplot)
```
  
There are a lot of outliers, especially in the 2000's. The blue line shows the mean salary. We can see that in 1991 the mean and median salary started to diverge. In 2000 there was a leap in the median salary, and in and after 2009, the highest salaries so far were payed. 
  
###About missing data
To find out about missing data, the number of teams and players was analyzed. Explicitly missing data is not stored in the tables we have, but we will check if there is implicitly missing data. 
```{r tidy=TRUE, salaries_missing_data_teams}
#graph with number of teams per year
sal_bb_nbteams <- ggplot(data = sal_bb_stats, mapping = aes(x = yearID, y = n_teams)) + 
  geom_line(color = "#3068A1") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = Salaries$yearID) +
  labs(x = "Year", y = "Number of teams", 
       title = "Number of Teams with salary information each year")
div(ggplotly(sal_bb_nbteams), align = "center")
```
  
In 1989 we have 26 teams with salary information, rising to 28 in 1993 and then after 1998 there are 30 teams. Looking at the [development of baseball teams](https://en.wikipedia.org/wiki/Timeline_of_Major_League_Baseball) it seems, that there is no implicitly missing data, as the number of teams rose similarly.   

``` {r tidy=TRUE, salaries_missing_data_players}
#preparing the graph with number of players per year
  #gathering the data to make to lines with 1 variable
sal_bb_nbplayers <- sal_bb_stats %>%
  gather(key="statistics_type", value = "Number_of_players", n_dist_players, n_players)
#changing the names (for the legend with ggplotly (labels in scale_color_manual would not work))
sal_bb_nbplayers$statistics_type <- str_replace_all(sal_bb_nbplayers$statistics_type, 
  c("n_dist_players" = "Distinct number of players", "n_players" = "Number of players"))
#making the plot
sal_bb_nbplayers <- ggplot(sal_bb_nbplayers) + 
  geom_line(mapping = aes(x = yearID, y = Number_of_players, color = statistics_type)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = Salaries$yearID) +
  labs(x = "Year", y = "Number of players",
       title = "Number of players with salary information each year") +
  scale_color_manual(values = c("#384F5d", "#3068A1"))
ggplotly(sal_bb_nbplayers) %>%
  #editing the legend to be beneath
  layout(legend = list(orientation = "h", x = 0, y = -0.3)) %>%
  div(align = "center")
```
  
The number of players spikes a lot through the years, which indicates implicitly missing data. A comparison to other data on the [number of players](https://www.statista.com/statistics/639334/major-league-baseball-players-on-opering-day-rosters/) shows that in 2013 there were 856 players, where we only have salary information for 814 baseball players. 
There are also players, who got paid by more than one team a year, which can be seen in the difference between the number of players and the distinct number of players per year. We will keep all these players by now, as this is about average salaries. Whether somebody was paid twice or once does not matter - they played more, so they earned more. (For the analysis of the players, these will be dropped, but this will be explained later on.)  
  
##Salaries within the leagues 
We've seen the overall salaries, let's focus on the differences within the leagues. We have 2 leagues within the salaries data, the National League (NL) and the American League (AL). 
```{r tidy=TRUE, salaries_lg}
#computing the stats for leagues 
sal_bb_stats_lg <- Salaries %>%
  group_by(yearID, lgID) %>%
  summarise(n_players_lg = n(), 
         salary_lg_mean = mean(salary),
         salary_lg_max = max(salary),
         salary_lg_min = min(salary),
         salary_lg_median = quantile(salary, probs = 0.5)) %>%
  mutate(salary_lg_100perc = (salary_lg_mean-min(salary_lg_mean)/max(salary_lg_mean)))
(sal_bb_stats_lg)
#graph with the salaries, grouped by league
sal_lg <- 
  ggplot(data = Salaries, mapping = aes(x = yearID, y = salary)) + 
  geom_point(mapping = aes(color = lgID), alpha = "0.3", position = "jitter") + 
  geom_smooth(method='lm', se=F, color = "#93adc8") + 
  scale_color_manual(values=c("#446a8b", "#985c59")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = sal_bb_stats_lg$yearID) +
  labs(x = "Year", y = "Salary in million US$",
       title = "Baseball-players' salaries, grouped by league")
(sal_lg)
```
  
In the scatterplot we see, that the differences between the average salary and maximum salary grow with time in both leagues, so this this effect is not caused by one league paying highly more. But there are differences within the leagues: The maximum gaining players of the AL earn more money than the ones from the NL (except for 2015 and 2016).   
  
###Mean, median and range {.tabset .tabset-fade}
Let's also take a look at the mean and median salaries, as well as the range.  

####Mean and median salary {-}
```{r tidy=TRUE, salaries_lg_mean, out.height = '130%'}
#graph with median and mean salary per year and league
sal_bb_stats_lg_all <- sal_bb_stats_lg %>%
  gather(key="statistics_type", value = "salary", salary_lg_mean, salary_lg_median) %>%
  ggplot(mapping = aes(shape = lgID), size = 10) +
  geom_line(mapping = aes(x = yearID, y = salary, color = lgID)) +
  scale_color_manual(values=c("#446a8b", "#985c59")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = sal_bb_stats_lg$yearID) +
  labs(x = "Year", y ="Salary (mean, median) in million US$",
       title = "Median and mean salary per year and league")
stat_type_names <- c(salary_lg_median = "Median Salary", salary_lg_mean = "Mean Salary")
(sal_bb_stats_lg_all)+facet_wrap(vars(statistics_type), nrow=2, labeller = as_labeller(stat_type_names))
```
  
Over the average salaries, both leagues rose alike. Although in 2005 the AL started to pay more than the NL. But the NL followed up and in 2015 the NL even had a higher median salary. The graph shows again, that the mean salary rose to 4-5 million US\$, whereas the median salary increased only to 1-2 million US\$. (Difference of 3-4 million US\$ when looking at mean or median!)
  
####Range of salaries {-}
``` {r tidy=TRUE, salaries_lg_range}
#Range of bb salaries in leagues
sal_bb_stats_lg_range <- 
  ggplot(data = sal_bb_stats_lg, mapping = aes(color = lgID)) +
  geom_line(mapping = aes(x = yearID, y = salary_lg_max-salary_lg_min)) +
  scale_color_manual(values=c("#446a8b", "#985c59")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = sal_bb_stats_lg$yearID) +
  labs(x = "Year", y = "Range of salaries in mllion US$", 
       title = "Range of baseball players' salaries by league")
(sal_bb_stats_lg_range)
```
  
Looking at range, which tells us about the gap between the minimum and maximum salary of the players, we can see, that it was increasing over time. Also, until 2014 the AL range was higher, then it dropped, whereas the NL range continued to rise.    
  
##Compared to US-salaries {.tabset .tabset-fade}
The average baseball salaries increased a lot with time. Let's compare it to the average US salaries and see if they rose alike. You can choose between the absolute comparison or the percentage change over time. 

###Comparison to US-salaries absolute {-}
```{r tidy=TRUE, salaries_comparison_us1} 
sal_bb_us <- left_join(sal_bb_stats_90, Salaries_US, by = "yearID")
(sal_bb_us) 
#graph with average salaries per year for bb
sal_bb_us_av <- 
  ggplot(data = sal_bb_us) + 
  geom_point(mapping = aes(x = yearID, y = salary_mean), color = "#446A8B") + 
  geom_smooth(mapping = aes(x = yearID, y = salary_mean), color = "#748CA1", method='lm', se=F) + 
  geom_point(mapping = aes(x = yearID, y = av_wage_US), color = "#555822") + 
  geom_smooth(mapping = aes(x = yearID, y = av_wage_US), color = "#969656", method='lm', se=F) + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = sal_bb_us$yearID) +
  labs(x = "Year", y = "Average salary in million US$", 
       title = "Average salary of baseballers and US citizens")
(sal_bb_us_av)
```
  
We can see, that the average salary of baseball players is a lot higher. To see the differences in the development more, we compare the percentage rise over time.   
  
###Comparison in percentage rise {-}
```{r tidy=TRUE, salaries_comparison_us2} 
sal_bb_us_dev <- ggplot(data = sal_bb_us) + 
  geom_point(mapping = aes(x = yearID, y = salary_mean_100perc), color = "#446A8B") + 
  geom_smooth(mapping = aes(x = yearID, y = salary_mean_100perc), color = "#748CA1", method='lm', se=F) + 
  geom_point(mapping = aes(x = yearID, y = av_wage_100perc), color = "#555822") + 
  geom_smooth(mapping = aes(x = yearID, y = av_wage_100perc), color = "#969656", method='lm', se=F) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = sal_bb_us$yearID) +
  labs(x = "Year", y = "% rise in salary of baseballers and US citizens", 
       title = "Salarydevelopment of baseballers and US citizens")
(sal_bb_us_dev)
```
  
Starting at 1990 (because the US Salary data is not available for the years before), the average US wages increased about 25% until 2016, whereas the baseball players' salaries increased more than 85%. This is a huge difference. So, baseball probably became more popular or (at least) people wanted to spend more on the games and the teams. Another reason for the players getting more money would be that the teams got more money because of bigger sponsoring.

##Mostpaying teams
We saw that both leagues paid more over time. Let's also take a look at the different teams. As we have data on at least 30 teams per year and the teams changed over time, we will only look at the most recent ones from 2016. We're going to find out the teams which paid the most for their players and look at their development. Also, we will make a linear model to see if the teams who pay more, also win more. 

###2016's Top 6 over time {.tabset .tabset-fade}
The Top 6 is defined by the mean salary per player and the sum paid per team. The analysis started with defining the Top 5, but it turned out, that the San Francisco Giants (SFN) and Texas Rangers (TEX) were both number 5, one when looking at the mean, the other with the sum. Therefore a Top 6 was chosen, because both the sum and the average have their advantages and disadvantages (the sum is affected by the number of observations we have for each team, whereas the average can be decreased by having more information on little earning players).

```{r  tidy=TRUE}
#getting the top5 most spending teams
mostpaying_teams <- Salaries %>%
  filter(yearID == 2016) %>%
  group_by(yearID, teamID) %>%
  summarise(salary_mean = mean(salary)) %>%
  arrange(desc(salary_mean))
mostpaying_teams <- mostpaying_teams[1:6,]
#getting all data on those teams, calculating the sum and average salary
mostpaying_teams_dev <- Salaries %>%
  filter(teamID %in% mostpaying_teams$teamID) %>%
  group_by(yearID, teamID) %>%
  summarise(salary_sum = sum(salary), 
            salary_mean = mean(salary))
```
  
####Sum of money spent per team {-}
```{r  tidy=TRUE}
#plotting the sum of salaries
sal_mostp_teams_sum <- 
  ggplot(data = mostpaying_teams_dev) + 
  geom_line(mapping = aes(x = yearID, y = salary_sum, color = teamID)) + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_color_manual(values = color$team_main) +
  scale_x_continuous(breaks = sal_bb_stats_lg$yearID) +
  labs(x = "Year", y = "Money spent on players per team in million US$",
       title = "Money spent on players per team (5 most paying teams)")
div(ggplotly(sal_mostp_teams_sum), align = "center")
```
  
The Boston Red Sox (BOS), Detroit Tigers (DET), Los Angeles Dodgers (LAN), New York Yankees (NYA), San Francisco Giants, and  Texas Rangers spent the most money on their players in 2016. Looking at their development, the NYA paid a lot more since 2002. LAN had a big rise in 2013, and TEX had less money between 2004 and 2010. As we know, that the number of players with salary information is not constant, changes in the salary sum can be due to the changing number of players. 
  
####Average salary paid per team {-}
```{r  tidy=TRUE}
#plotting the average salary
sal_mostp_teams_mean <- 
  ggplot(data = mostpaying_teams_dev) + 
  geom_line(mapping = aes(x = yearID, y = salary_mean, color = teamID)) + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_color_manual(values = color$team_main) +
  scale_x_continuous(breaks = sal_bb_stats_lg$yearID) +
  labs(x = "Year", y = "Mean salary paid per team in million US$",
       title = "Mean salary paid per team (5 most paying teams)")
div(ggplotly(sal_mostp_teams_mean), align = "center")
```
  
As the sum is not a perfect indicator, we also look at the mean salary per team. Here the development is similar, so it seems, that the sum spent or mean salary does not affect the analysis so much (at least with the Top 6)
  
###Mostpaying teams and Win proportion {.tabset .tabset-fade}
We also want to analyze if the teams paying *high salaries* for their players also win the most. We will take a look at the median salary, the maximum for one player per team and the sum spent per team. For the wins we will use the *Wins per Games* from the Age table. Getting this information to the salaries, does not cause any data loss, which is shown by the 0 rows in the anti-joins. 

```{r tidy=TRUE, sal_teams_prep}
salaries16_teams <- Salaries %>%
  filter(yearID == 2016) %>%
  group_by(teamID) %>%
  summarise(n_players = n(), 
            #sal_min = min(salary),
            sal_max_prop = max(salary)/sum(salary),
            sal_median = median(salary),
            #sal_mean = mean(salary),
            sal_sum = sum(salary))
salaries16_teams_games <- inner_join(salaries16_teams,  
                                    (Teams %>% filter(yearID == age_current) %>% 
                                               select(teamID,G, W, L) %>% 
                                               mutate(Wprop = (W/G)*100)),
                                     "teamID")
salaries16_teams_games
(anti_join((Teams %>% filter(yearID == age_current) %>% 
                      select(teamID,G, W, L)) %>% 
                      mutate(Wprop = W/G), salaries16_teams, "teamID"))
            
(anti_join(salaries16_teams, 
           (Teams %>% filter(yearID == age_current) %>% 
                      select(teamID,G, W, L) %>% 
                      mutate(Wprop = W/G)), 
           "teamID"))
```
  
Now we can construct the linear model with our formula (from help.R). Using the safely version, we do not get any errors.  
We look at the median, maximum and sum spent. 
  
####Median salary and Win proportion {-}

$\widehat{\text{Wins%}}_i = \hat{\beta_0} + \hat{\beta_1} \text{Median Salary per Team}_i$ 
```{r tidy=TRUE, sal_teams_wprop_med}
#linear model for the median salary per team
salaries16_teams_med <- safe_lm_own(salaries16_teams_games, "Wprop", "sal_median", 
                               "% Games won", "Median player's salary in million US$ per team", 
                               "Linear model of the % Games won \nand median salary per team")
(salaries16_teams_med)
```
  
The linear model shows, that the higher the median salary, the more games are won. But the residuals are very high, why one cannot trust this conclusion of correlataion between median salary and % Games won.   

  
####Maximum salary and Win proportion {-}
$\widehat{\text{Wins%}}_i = \hat{\beta_0} + \hat{\beta_1} \text{Proportion of the Maximum Salary per Team}_i$
```{r tidy=TRUE, sal_teams_wprop_max}
#linear model for the maximum salary per team 
salaries16_teams_max_prop <- safe_lm_own(salaries16_teams_games, "Wprop", "sal_max_prop", 
                                    "% Games won", "Proportion of Maximum player's salary", 
                                    "Linear model of the % Games won \nand proportion of maximum salary per team")
(salaries16_teams_max_prop)
```
  
The proportion of maximum salary is the $\frac{\text{Maximum salary}}{\text{Sum of Salaries}} \text{per Team}$. The linear model shows us, that one player with a much higher salary than the others, does not correlate with the team winning more. It is even better, to have the salaries more even, to win more. (Or teams win more, when having salaries even.)
  
####Sum of salaries and Win proportion {-}
$\widehat{\text{Wins%}}_i = \hat{\beta_0} + \hat{\beta_1} \text{Sum of Salaries per Team}_i$
```{r tidy=TRUE, sal_teams_wprop_sum}
#linear model for the sum of salaries paid per team 
salaries16_teams_sum <- safe_lm_own(salaries16_teams_games, "Wprop", "sal_sum", 
                               "% Games won", "Money spent on players in million US$ per team", 
                               "Linear model of the % Games won \nand Money spent on players per team")
(salaries16_teams_sum)
```
  
The sum of money spent on players per team is correlating with the %Games won. The more money a team spends, the more games are won (or the more games are won, the more money is spent).
  
###\ {-}
So the conclusion of these models is, that there is a relation between the money spent and the games won, at least when looking at the sum and the proportion of the maximum salary. 
```{r tidy=TRUE, results = "asis"}
sal_lm_t1 <- lm(Wprop~sal_median, data = salaries16_teams_games)
sal_lm_t2 <- lm(Wprop~sal_max_prop, data = salaries16_teams_games)
sal_lm_t3 <- lm(Wprop~sal_sum, data = salaries16_teams_games)

stargazer(sal_lm_t1, sal_lm_t2, sal_lm_t3, type = "html", align = T)
```
<br>
This is also shown in the summary above. The p-values are <0.01 with the sum and the proportion of the maximum salary, and they also have higher RÂ². 
  
##Mostpaid players
We now saw the teams and their salaries. We also want to take a look at the players themselves. The rise in the salaries was mainly conducted by some high earninig players. Why do they get paid so much more than others? Are they better? To answer these questions we will look again at the latest data available from 2016 and find out the players with the largest salaries. Then we will make an analysis of this year to see if the ones gaining more also played better and vice versa. 

###2016's Top 5 over time
To get the Top 5 most paid players of 2016 and then look at their development we use the `Salaries` table. 

```{r tidy=TRUE, sal16_most_players}
#getting players for only 2016, players with more than one salary will be excluded
salaries16_players <- Salaries %>%
  filter(yearID == 2016) %>%
  group_by(playerID) %>%
  summarise(n_plID = n()) %>%
  filter(n_plID == 1)%>%
  print()
#getting the salaries for all these players
salaries16 <- Salaries %>%
  filter(yearID == 2016) %>%
  filter(playerID %in% salaries16_players$playerID)%>%
  print()
#getting the names of the top5 earning players in 2016
sal16_pl_top5 <- Salaries %>%
  filter(playerID %in% salaries16$playerID) %>%
  arrange(desc(yearID), desc(salary))%>%
  print()
sal16_pl_top5 <- sal16_pl_top5[1:5,]
#getting the development of the top5 earning players
sal_mostp_pl_in16 <- Salaries %>%
  filter(playerID %in% sal16_pl_top5$playerID) %>%
  arrange(desc(yearID), desc(salary))%>%
  print()
sal_mostp_pl_in16
sal_mostp_pl_in16_plot <- ggplot(data = sal_mostp_pl_in16, mapping = aes(x = yearID, y = salary)) + 
  geom_line(mapping = aes(color = playerID)) + 
  scale_color_manual(values = c("#A7C4E3", "#74a9cf", "#4B88C8", "#446a8b", "#323135")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_x_continuous(breaks = sal_bb_stats_lg$yearID) +
  labs(x = "Year", y = "Salary per player in million US$", 
       title = "Salaries of the mostpaid baseball-players over time")
(sal_mostp_pl_in16_plot)
```
  
Kershcl01, most earning in 2015 and 2016, had a shorter career (like Priceda01) comparing to the others. Priceda01 had the highest salary to start with. The other players have been playing in Major League Baseball for at least 10 years before getting paid more than 25 million US\$. 
  
###High paid players and Wins Above Replacement {.tabset .tabset-fade}
To find out about the relationship of salary and being a good player, we'll construct a linear model. We will compare the players' salaries to the Wins above replacement for position players and for pitching (WARpos and WARpit). 

Before constructing the model, we need to prep our data. We make two tables, one containing WARpos and the other WARpit. We loose for position players: `r nrow(anti_join(salaries16, pos_2016, "playerID"))` salary statistics and `r nrow(anti_join(pos_2016, salaries16, "playerID"))` players with WAR. We loose for pitching: `r nrow(anti_join(salaries16, pit_2016, "playerID"))` salary statistics and `r nrow(anti_join(pit_2016, salaries16, "playerID"))` players with WAR. 

```{r tidy=TRUE, salaries16_prep}
#using an inner join to only hold the rows with WAR and salary
salaries16_pl_warPos <- inner_join(salaries16, pos_2016, "playerID")
(anti_join(salaries16, pos_2016, "playerID"))
(anti_join(pos_2016, salaries16, "playerID"))
#using an inner join to only hold the rows with WAR and salary
salaries16_pl_warPit <- inner_join(salaries16, pit_2016, "playerID")
#using anti_joins in both directions to see the data loss
(anti_join(salaries16, pit_2016, "playerID"))
(anti_join(pit_2016, salaries16, "playerID"))
```
  
####WAR for position players and salary {-}
$\widehat{\text{weighted WAR pos}}_i = \hat{\beta_0} + \hat{\beta_1} \text{Salary per Player}_i$ 
```{r tidy=TRUE, lm_salary_war_pos}
lm_salary_warpos <- safe_lm_own(salaries16_pl_warPos, "weightedWAR", "salary",
                           "Wins above replacement (pos. players)", "Salary in million US$", 
                           "Linear model on Wins above Replacement for position players \nand the player's salary")
(lm_salary_warpos)
```
  
The salary and wins above replacement indicator for position players are not really related. There seems to be a slightly positive correlation, with more salary meaning higher WAR (or vice versa). But there are a lot of observations with little salary and a lot with WAR around 0. 
  
####WAR for pitching and salary {-}
$\widehat{\text{weighted WAR pit}}_i = \hat{\beta_0} + \hat{\beta_1} \text{Salary per Player}_i$ 
```{r tidy=TRUE, lm_salary_war_pit}
lm_salary_warpit <- safe_lm_own(salaries16_pl_warPit, "weightedWAR", "salary",
                           "Wins above replacement (pitching)", "Salary in million US$", 
                           "Linear model on Wins above Replacement for pitching \nand the player's salary")
(lm_salary_warpit)
```
  
For pitching, the Wins above replacement indicator and the salary show less correlation than the linear model with WAR for position players. Here we can see again, that there are a lot observations around 0 spread on both axes. 

```{r tidy=TRUE, results = "asis"}
sal_lm_p1 <- lm(weightedWAR~salary, data = salaries16_pl_warPos)
sal_lm_p2 <- lm(weightedWAR~salary, data = salaries16_pl_warPit)

stargazer(sal_lm_p1, sal_lm_p2, type = "html", align = T)
```
  

#Of Handedness, Age and Salaries 
The last chapter looks at all the factors described above, and figures out the relation between age, salary and handedness and the baseball-player's success. The sucess of a baseball player is measured by the Wins Above Replacement (WAR). 

##Linear Model {.tabset}
For our final linear model we enter all of the variables above as covariates to predict a player's expected weighted WAR. Also, we include an interaction term for age and salary. The rationale behind this is that we suspect the strength of the relationship between salary and weighted WAR to vary as a function of age. More precisely, younger players who are under their first contract could be relatively important to their teams, however get paid relatively less as opposed to older players who are beyond their first contract. That is, we consider it reasonable to suspect that older, established players (beyond their first contract) are paid according to their actual performance, whereas younger players are paid according to their presumed potential. We also included handedness as a covariate, with a player's throwing hand as a proxy for "handedness". Also, we will only look at the weighted WAR for position players.

The model:
```{r  tidy=TRUE}
#Add column age to the salaries16_pl_warPos data frame

# #Check if playerID is key
# salaries16_pl_warPit %>% 
#   count(playerID) %>% 
#   filter(n>1)

# #Check if playerID is key
# salaries16_pl_warPos %>% 
#   count(playerID) %>% 
#   filter(n>1)

df16 <- inner_join(salaries16_pl_warPos, age_c_players, by = c("playerID","teamID"))

#linear model contains a player's throwing hand, his age, his salary, and the
#interaction between age and salary
finalModel <- lm(weightedWAR~throws+age+salary+age*salary, data=df16)
```

$$
\widehat{\text{weighted WAR}}_i = \widehat{\beta}_0+\widehat{\beta}_1\text{Left}_i+\widehat{\beta}_2\text{Age}_i+\widehat{\beta}_3\text{Salary}_i+\widehat{\beta}_4\text{Age}_i\times\text{Salary}_i
$$   
```{r tidy=TRUE, results = "asis"}
stargazer(finalModel, align = T , type="html") #display summary statistics
```  
<br> 

Unsurprisingly (and in light of the previous linear models) our final model does not "explain" the data very well ($R^2$ < .06).   

To visualize the observed data, we create a 3-D scatter plot, with age and salary on the x- and y-axes, and weighted WAR on the z-axis. We use different colors in order to distinguish between the two handedness groups.

```{r  tidy=TRUE}
#define scatter plot for left-handed players as a plolty object 
observed_left <- plot_ly(
  filter(df16, throws=="Left"), color = ~throws #required to assign color
) %>% 
  add_trace( #add_markers is comparable to geom_point()
    name = "Left-Handed Observed", #names the plotly object
    x = ~age, 
    y = ~salary,
    z = ~weightedWAR,
    marker = list(
      color = "#446A8B",
      size = 4
    )
  )

#define scatter plot for right-handed players as a plolty object 
observed_right <- plot_ly(filter(df16, throws == "Right"), color = ~throws
) %>% 
  add_trace(
    name = "Right-Handed Observed",
    x = ~age,
    y = ~salary,
    z = ~weightedWAR,
    marker = list(
      color = "#555822",
      size = 4
    )
  )

#subplot merges two plotly objects (here: observed_left, and observed_right)
#function div() is used to center the scatter plot
div(subplot(observed_left, observed_right) %>% 
  layout( #layout is used to specify titel and axis labels
    title = 
      "Observed Weighted WAR by Age, Salary and Handedness",
    scene = list(
      xaxis = list(title = "Age"),
      yaxis = list(title = "Salary"),
      zaxis = list(title = "Weighted Wins Above Replacement"))
  ), align="center")
```

To visualize the linear trend fitted by our model, we plotted two separate regression planes, one for each handedness group.

```{r  tidy=TRUE}
age_grid <- seq_range(df16$age,10) #specify x values for the surface grid
salary_grid <- seq_range(df16$salary, 10) #speciy y values for the surface grid

#returns a matrix of fitted values for right-handed players
fit_right <- outer(
  age_grid,
  salary_grid,
  #FUN is the equation of the linear model for right-handed players.
  #Right-handed is coded as 0.
  ##Coefficients are taken from the final model's summary table.
  FUN = function(age_grid, salary_grid) { 
    finalModel$coefficients[[1]]+
      finalModel$coefficients[[3]]*age_grid+
      finalModel$coefficients[[4]]*salary_grid+
      finalModel$coefficients[[5]]*age_grid*salary_grid
  }
)

#returns a matrix of fitted values for left-handed players
fit_left <- outer(
  age_grid,
  salary_grid,
  #FUN is the equation of the linear model for left-handed players. 
  #Left-handed is coded as 1.
  #Coefficients are taken from the final model's summary table.
  FUN = function(age_grid, salary_grid){
    finalModel$coefficients[[1]]+
      finalModel$coefficients[[2]]+
      finalModel$coefficients[[3]]*age_grid+
      finalModel$coefficients[[4]]*salary_grid+
      finalModel$coefficients[[5]]*age_grid*salary_grid
  }
)

#Creates a regression surface for left-handed players as a plotly object
surface_left <- 
  plot_ly() %>% 
  add_surface(
    x = ~age_grid,
    y = ~salary_grid,
    z = ~fit_left,
    name = "Left-Handed",
    colorscale =list(c(0,1), c("#f2f2f2","#446A8B")),
    colorbar=list(title='Fitted WAR for Left-Handed Players')
  )

#Creates a regression surface for right-handed players as a plotly object
surface_right <- 
  plot_ly(color = ~fit_right) %>% 
  add_surface(
    x = ~age_grid,
    y = ~salary_grid,
    z = ~fit_right,
    name = "Right-Handed",
    colorscale = list(c(0,1), c("#f2f2f2", "#555822")),
    colorbar=list(title='Fitted WAR for Right-Handed Players')
  ) 

#Subplot merges the two regression plane into a single plotly object
div(subplot(surface_left, surface_right) %>% 
  layout(
    title = 
      "Fitted WAR For The Interaction Between 
           Age And Salary By Handedness",
    scene = list(
      xaxis = list(title = "Age"),
      yaxis = list(title = "Salary"),
      zaxis = list(title = "Weighted Wins Above Replacement"))
  ), align="center")
```

We also plot the residuals against our covariates (plus the interaction term) to see if there's any remaining trend in our data not accounted for by the model (presumably there is). 


```{r  tidy=TRUE}
#Add predicted values and residuals to df16
df16 <- df16 %>% 
  add_residuals(finalModel) %>% 
  add_predictions(finalModel)
```

###Handedness {-}
```{r  tidy=TRUE}
#returns residual plot for handedness
(p_resid_hand <- df16 %>% 
  ggplot(aes(throws, resid))+
  geom_point()+
  ggtitle("Residuals By Handedness")+
  xlab("Salary")+
  ylab("Residuals"))+
  geom_ref_line(h = 0)
```

###Age {-}
```{r  tidy=TRUE}
#returns residual plot for age
(p_resid_age <- df16 %>% 
   ggplot(aes(age, resid))+
   geom_point()+
   geom_ref_line(h = 0)+
   facet_wrap(~throws)+ #show separate plots for each handedness group
   ggtitle("Residuals By Age And Handedness")+
   xlab("Age")+
   ylab("Residuals")
)  

```  

###Salary {-}
```{r  tidy=TRUE}
#returns residual plot for salary
(p_resid_salary <- df16 %>% 
  ggplot(aes(salary, resid))+
  geom_point()+
  facet_wrap(~throws)+
  ggtitle("Residuals By Salary And Handedness")+
  xlab("Salary")+
  ylab("Residuals"))+
  geom_ref_line(h = 0)
```  


###Age by Salary {-}
```{r  tidy=TRUE}
#returns residual plot for age and salary interaction
(p_resid_age_salary <- df16 %>% 
  ggplot(aes(age*salary, resid))+
  geom_point()+
  facet_wrap(~throws)+
  ggtitle("Residuals By Age-By-Salary And Handedness")+
  xlab("Age-by-Salary")+
  ylab("Residuals"))+
  geom_ref_line(h = 0)
```
The scatter plots for age/salary/age-by-salary and the residuals look nothing like random noise. It is most likely that there is a pattern in the data that was not captured by our model.  

#Concluding Remarks   
In this project we analyzed data from Sean Lahman's baseball datbase. We looked at changes in hand preference over time, and the association between hand preference and player performance (as measured by relative value; WAR). Then we considered the association between age, and both, team and individual performance. Also, we looked at changes in player salaries and associations between salary and team/individual performance. Finally we looked at the association between hand preference, age and player salary with respect to individual performance.  
We conclude that the distributions of players' preferred batting and throwing hands have not really changed since 1871, and that handedness does not predict individual performance. Our linear models indicate that teams that spent more on player salary, were also more successful. Also, teams that were, on average, older seem to have performed better (as measured by wins), however, player performance did not seem to differ as a function of age, or salary. A suspected interaction between age and salary also did not turn out to be predictive of individual performance. 

#Appended Code
  
```{r  tidy=TRUE}
#This code can be used to visualize a three-way interaction between handedness, age, and salary with respect to weighted WAR. Separate linear models for each batting and throwing group are computed.
# threeD <- function(df){
#   models <- list()
#   models <- list(
#     batsRight <- list(df[df[["bats"]]=="Right",]),
#     batsLeft <- list(df[df[["bats"]]=="Left",]),
#     batsBoth <- list(df[df[["bats"]]=="Both",]),
#     throwsLeft <- list(df[df[["throws"]]=="Left",]),
#     throwsRight <- list(df[df[["throws"]]=="Right",])
#   )
#   for (i in seq_along(models)){
#     models[[i]][2] <- lapply(
#       models[[i]][1], function(x){
#         lm(weightedWAR~age*salary, data=x)
#       }
#     )
#   }
#   for(i in seq_along(models)){
#     models[[i]][[3]] <- list(
#       x = seq_range(na.omit(models[[i]][[1]][["age"]]), 10),
#       y = seq_range(na.omit(models[[i]][[1]][["salary"]]),10),
#       z = outer(seq_range(na.omit(models[[i]][[1]][["age"]]), 10), 
#                 seq_range(na.omit(models[[i]][[1]][["salary"]]),10), 
#                 FUN = predictSurface, model = models[[i]][[2]])
#     )
#   }
#   name <- 
#     c("Right-Handed Batters", "Left-Handed Batters", 
#       "Both-Handed Batters", "Left-Handed Throwers", 
#       "Right-Handed Throwers")
#   names(models) <- name
#   for (i in seq_along(models)){
#     models[[i]]$plot <- plot_ly(models[[i]][[1]], x=~age, y=~salary, z=~weightedWAR) %>% 
#       add_surface(
#         x = ~models[[i]][[3]]$x,
#         y = ~models[[i]][[3]]$y,
#         z = ~models[[i]][[3]]$z
#       ) %>% 
#       add_markers(
#         marker = list(color = "#446A8B", symbol = "circle", size = 4)
#       ) %>% 
#       layout(
#         title = paste0("Interaction Between Age and Salary for ",name[i]),
#         scene = list(
#           xaxis = list(title = "Age"),
#           yaxis = list(title = "Salary"),
#           zaxis = list(title = "Weighted Wins Above Replacement"))
#       ) 
#       
#   }
#   models
# }
# 
# div(threeD(df16)$'Right-Handed Throwers'$plot, align = "center")


### Salaries: calculating the players with the max salary since 1999
# salary_max <- Salaries %>%
#   filter(yearID > 1999) %>%
#   group_by(yearID) %>%
#   mutate(max_salary = max(salary)) %>%
#   subset(salary == max_salary) %>%
#   ungroup()
# (salary_max)
# checking how often somebody was mostpaid
# mostpaid_players <- salary_max %>%
#   group_by(playerID) %>%
#   summarise(mostpaid_player = n()) %>%
#   ungroup()
# (mostpaid_players)
# getting the salary development of the max paid players (2000-2016)
# sal_mostp_pl <- Salaries %>%
#   filter(playerID %in% (salary_max$playerID))
# (sal_mostp_pl)

### Salaries: displaying the players with the max salary since 1999 and their development 
##The two most earning players in 2015 and 2016 (Greinza01 and Kershcl01) were quite new in the game, whereas rodrial01 was the mostpaid player for a long time. Brownke01, playing until 2005, had a long career before he was most paid. After getting most money, he didnt develop anymore, his salary stayed the same. Giambja01 and Ramirma01 had a similar development in salary, with Ramirma01 getting less between 2007 and 2009 and then earning more again. 

# sal_mostp_pl_all <- 
#   ggplot(data = sal_mostp_pl, mapping = aes(x = yearID, y = salary)) + 
#   geom_line(mapping = aes(color = playerID)) + 
#   geom_point(mapping = aes(color = playerID))+
#   scale_color_manual(values = c("#A7C4E3", "#74a9cf", "#4B88C8", "#0570b0", "#446a8b", "#323135")) +
#   theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
#   scale_x_continuous(breaks = sal_bb_stats_lg$yearID) +
#   labs(x = "Year", y = "Salary per player in million US$", 
#        title = "Salaries of the mostpaid baseball-players over time")
# (sal_mostp_pl_all)
```
  

```
